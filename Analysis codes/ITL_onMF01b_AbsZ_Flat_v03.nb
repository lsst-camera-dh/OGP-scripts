(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 9.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[    154300,       4693]
NotebookOptionsPosition[    134597,       4160]
NotebookOutlinePosition[    135606,       4196]
CellTagsIndexPosition[    135402,       4188]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell["ITL sensor on MF01b - Flatness, AbsHgt", "Title"],

Cell["PZ Takacs", "Subsubtitle"],

Cell["ITLonMF01b_AbsZ_Flat_v01.nb", "Subtitle"],

Cell["Extracted from SurfAnal10b", "Subtitle"],

Cell["\<\
2015.08.19 - v03 -Added statistics report TXT file output. Added CleanSlate \
to reset system during Init.
2015.08.17 - Rename to indicate this produces results for both AbsZ and \
Flatness from measurements made with sensor on MF01b fixture, rather than on \
shipping jig. Automatic export of all data products. Changed product file \
names to conform to eTraveler convention.
2015.06.22 - Modify for ITL sensor on MF01b for abs hgt and flatness. Edge \
scan does not enter into this analysis.
2014.11.21 - ver. 4 Customize for production CCD flatness and height \
measurement. Include upstemcal offset factor for absolute height correction.
\
\>", "Subsubtitle"],

Cell[CellGroupData[{

Cell["\<\
Fuly automated run starts here. Just answer the questions and the nb will run \
to completion and output all of the data products to the working directory.\
\>", "Section"],

Cell[CellGroupData[{

Cell["\<\
1. Initialize - resets the system to pristine state each time.\
\>", "Section",
 InitializationGroup->True],

Cell["\<\
Run CleanSlate each time this nb is run to purge all prior expressions and \
output.\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"<<", "Utilities`CleanSlate`"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"CleanSlate", "[", "]"}]], "Input"],

Cell["\<\
Data and time of last saved modification. This is an Initialization cell that \
executes automatically whenever the nb is opened.\
\>", "Text",
 CellChangeTimes->{{3.446131848655753*^9, 3.446131858917453*^9}, {
  3.446137264759386*^9, 3.446137266332767*^9}, {3.446137346018297*^9, 
  3.44613737617555*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"autoOutput", "=", "True"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"autoOutput", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<Set autoOutput flag to False to suppress automatic uotput of data \
product files.\>\"", ",", "autoOutput"}], "]"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{"nb", "=", 
  RowBox[{"EvaluationNotebook", "[", "]"}]}]], "Input",
 InitializationGroup->True,
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"DateString", "[", 
  RowBox[{
   RowBox[{"\"\<FileModificationTime\>\"", "/.", 
    RowBox[{"NotebookInformation", "[", "]"}]}], ",", 
   RowBox[{"TimeZone", "->", "0"}]}], "]"}]], "Input",
 InitializationCell->True,
 InitializationGroup->True,
 CellAutoOverwrite->False,
 CellChangeTimes->{{3.445874966493102*^9, 3.4458749784889708`*^9}, {
   3.445875037268758*^9, 3.445875100082447*^9}, {3.4458751485534067`*^9, 
   3.4458751511117163`*^9}, {3.445875216915934*^9, 3.445875242570963*^9}, {
   3.445875378437434*^9, 3.445875401114954*^9}, 3.445875458892804*^9, {
   3.44587557913221*^9, 3.44587559106078*^9}, {3.445875627487088*^9, 
   3.4458756403413153`*^9}}],

Cell[BoxData[{
 RowBox[{"Off", "[", 
  RowBox[{"General", "::", "\"\<spell1\>\""}], "]"}], "\n", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"<<", "\"\<BarCharts`\>\""}], ";", 
    RowBox[{"<<", "\"\<Histograms`\>\""}], ";", 
    RowBox[{
     RowBox[{"<<", "\"\<PieCharts`\>\""}], "\n", 
     RowBox[{"<<", "\"\<LinearRegression`\>\""}]}]}], "*)"}]}]}], "Input",
 InitializationGroup->True,
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"<<", "ComputationalGeometry`"}]], "Input",
 InitializationGroup->True],

Cell[BoxData["$SystemID"], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.4160021152075243`*^9, 3.416002130753045*^9}}],

Cell[BoxData["$OperatingSystem"], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115207933*^9, 3.416002130753488*^9}}],

Cell[CellGroupData[{

Cell["\<\
Conversion factors to meters for numbers in the indicated units:\
\>", "Subsubsection",
 InitializationGroup->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"mm", "=", 
   RowBox[{"10.", "^", 
    RowBox[{"-", "3"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"micron", "=", 
   RowBox[{"10.", "^", 
    RowBox[{"-", "6"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Micro]m", "=", 
   RowBox[{"10.", "^", 
    RowBox[{"-", "6"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nm", "=", 
   RowBox[{"10.", "^", 
    RowBox[{"-", "9"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Angstroms", "=", 
   RowBox[{"10.", "^", 
    RowBox[{"-", "10"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"micronsToAngstroms", "=", 
   RowBox[{"10", "^", "4"}]}], ";"}]}], "Input",
 InitializationGroup->True,
 CellAutoOverwrite->False]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["2. Define statistical functions for profile data.", "Section",
 CellMargins->{{Inherited, 73}, {Inherited, Inherited}},
 InitializationGroup->True,
 CellChangeTimes->{{3.411413798108049*^9, 3.4114138294439096`*^9}, {
  3.411413867973627*^9, 3.411413868916065*^9}, {3.4160021152099953`*^9, 
  3.416002130754035*^9}},
 AspectRatioFixed->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"hrange", "[", 
   RowBox[{"binlist_", ",", "min_", ",", "max_"}], "]"}], ":=", 
  RowBox[{"Quantile", "[", 
   RowBox[{"binlist", ",", 
    RowBox[{"{", 
     RowBox[{"min", ",", "max"}], "}"}]}], "]"}]}]], "Input"],

Cell["\<\
MAKE SURE THE FOURIER OPTIONS ARE SET CORRECTLY EACH TIME THE FT IS DONE.\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.4127080426338873`*^9, 3.412708073368338*^9}, {
  3.416002115210246*^9, 3.416002130754343*^9}}],

Cell["\<\
Define the biased stddev functiion. The built in StdDev fcn has n-1 in the \
denom. Change it to n.\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.411244601232059*^9, 3.4112446126083603`*^9}, {
  3.411401892850431*^9, 3.411401941242345*^9}, {3.416002115210606*^9, 
  3.416002130754509*^9}}],

Cell["\<\
Now compute std dev in different ways: The default StandardDeviation is the \
unbiased version, with n-1 in the denominator.\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.411244524906001*^9, 3.411244572336635*^9}, {
  3.416002115210808*^9, 3.4160021307546577`*^9}}],

Cell[BoxData[
 RowBox[{"sdevBiased", "=."}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411401237860261*^9, 3.411401238282799*^9}, {
  3.416002115211028*^9, 3.4160021307548733`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"sdevUnB", "[", "in_", "]"}], ":=", 
  RowBox[{"N", "[", 
   RowBox[{"StandardDeviation", "[", "in", "]"}], "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411241693395444*^9, 3.411241706616735*^9}, {
  3.411242342526307*^9, 3.411242343260508*^9}, {3.4114010974523697`*^9, 
  3.411401135523253*^9}, {3.411401176892941*^9, 3.411401193755307*^9}, {
  3.4160021152112923`*^9, 3.416002130755198*^9}},
 AspectRatioFixed->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"sdevBiased", "[", "in_", "]"}], ":=", 
  RowBox[{
   RowBox[{"StandardDeviation", "[", "in", "]"}], 
   RowBox[{"Sqrt", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Length", "[", "in", "]"}], "-", "1"}], ")"}], "/", 
     RowBox[{"Length", "[", "in", "]"}]}], "]"}]}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.4112442966263638`*^9, 3.4112442987370358`*^9}, {
  3.411244836691388*^9, 3.411244844963024*^9}, {3.411322834343668*^9, 
  3.41132284047543*^9}, {3.4114012049004307`*^9, 3.411401218283264*^9}, {
  3.4114018520153723`*^9, 3.411401862571908*^9}, {3.416002115211499*^9, 
  3.416002130755392*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"rmsBias", "[", "in_", "]"}], ":=", 
  RowBox[{"Sqrt", "[", 
   RowBox[{
    RowBox[{"Plus", "@@", 
     RowBox[{"(", 
      RowBox[{"in", "^", "2"}], ")"}]}], "/", 
    RowBox[{"Length", "[", "in", "]"}]}], "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412705383260199*^9, 3.412705384361855*^9}, {
  3.4160021152117662`*^9, 3.416002131149736*^9}}],

Cell["\<\
Next is the RMS. Sum the squares, divide by N and then take the root. (Root \
of the Mean Square)\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115211948*^9, 3.4160021311499767`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"rmsrawbiased", "=."}], ";"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411401278124251*^9, 3.411401281642796*^9}, {
  3.416002115212204*^9, 3.4160021311503077`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"rms", "[", "in_", "]"}], ":=", 
  RowBox[{"N", "[", 
   SqrtBox[
    FractionBox[
     RowBox[{"Plus", "@@", 
      SuperscriptBox[
       RowBox[{"(", "in", ")"}], "2"]}], 
     RowBox[{"Length", "[", "in", "]"}]]], "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411243208755157*^9, 3.411243232177184*^9}, {
  3.411244649291259*^9, 3.4112446502894506`*^9}, {3.4114012534292316`*^9, 
  3.4114012690438137`*^9}, {3.4114013017654133`*^9, 3.4114013100998917`*^9}, {
  3.4114026774688253`*^9, 3.411402697091949*^9}, {3.416002115212399*^9, 
  3.416002131150504*^9}},
 AspectRatioFixed->True],

Cell["\<\
See that one must subtract the mean from the input data first, before \
squaring, in order to compute the standard deviation correctly.\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115212542*^9, 3.416002131150723*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"sdevBruteUnBiased", "[", "in_", "]"}], ":=", 
  RowBox[{"N", "[", 
   SqrtBox[
    FractionBox[
     RowBox[{"Plus", "@@", 
      SuperscriptBox[
       RowBox[{"(", 
        RowBox[{"in", "-", 
         RowBox[{"Mean", "[", "in", "]"}]}], ")"}], "2"]}], 
     RowBox[{
      RowBox[{"Length", "[", "in", "]"}], "-", "1"}]]], "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411243259723289*^9, 3.4112432855454617`*^9}, {
  3.411244633618145*^9, 3.411244635137704*^9}, {3.4114013297411613`*^9, 
  3.411401333515849*^9}, {3.411401414885539*^9, 3.41140146711607*^9}, {
  3.411402743222232*^9, 3.411402743972342*^9}, {3.416002115212819*^9, 
  3.416002131150895*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"detrend", "[", 
   RowBox[{"anylist_", ",", "order_Integer"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"npts", ",", "xlist", ",", "fitlist", ",", "x"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"order", ">=", "0"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"xlist", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          SuperscriptBox["x", "i"], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "0", ",", "order"}], "}"}]}], "]"}]}], ";", "\n",
        "\t\t", 
       RowBox[{"npts", "=", 
        RowBox[{"Length", "[", "anylist", "]"}]}], ";", "\n", "\t\t", 
       RowBox[{"func", "=", 
        RowBox[{"Fit", "[", 
         RowBox[{"anylist", ",", "xlist", ",", "x"}], "]"}]}], ";", "\n", 
       "\t\t", 
       RowBox[{"fitlist", "=", 
        RowBox[{"{", "}"}]}], ";", "\n", "\t\t", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{"AppendTo", "[", 
          RowBox[{"fitlist", ",", "func"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "1", ",", "npts"}], "}"}]}], "]"}], ";", "\n", 
       "\t\t", 
       RowBox[{"Return", "[", 
        RowBox[{"anylist", "-", "fitlist"}], "]"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "anylist", "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115213029*^9, 3.416002131151075*^9}},
 AspectRatioFixed->True],

Cell[CellGroupData[{

Cell["\<\
Define a RMS function to compute rms from PSD data. Input arguments are: \
psd=name of PSD list; ntot=total points in source profile; delx= physical \
increment value for each data point step; lo and hi = index value in the PSD \
list.\
\>", "Subsubsection",
 InitializationGroup->True,
 CellChangeTimes->{{3.411414167914678*^9, 3.411414349868288*^9}, {
  3.4160021152141542`*^9, 3.416002131151362*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"psd1", "[", 
   RowBox[{"in_", ",", "delx_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"SetOptions", "[", 
     RowBox[{"Fourier", ",", 
      RowBox[{"FourierParameters", "\[Rule]", 
       RowBox[{"{", 
        RowBox[{"1", ",", "1"}], "}"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
    RowBox[{"nPts", "=", 
     RowBox[{"Length", "[", "in", "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"FTwork", "=", 
     RowBox[{"Fourier", "[", "in", "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"psd2side", "=", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"2", " ", 
        RowBox[{"delx", "/", "nPts"}]}], ")"}], " ", 
      RowBox[{
       RowBox[{"Abs", "[", "FTwork", "]"}], "^", "2"}]}]}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{"psd1side", "=", 
     RowBox[{"Drop", "[", 
      RowBox[{"psd2side", ",", 
       RowBox[{"-", 
        RowBox[{"Floor", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"nPts", "-", "1"}], ")"}], "/", "2"}], "]"}]}]}], "]"}]}], 
    ";", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
     "Apply", " ", "bookkeeping", " ", "factors", " ", "to", " ", "end", " ", 
      "terms"}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"psd1side", "[", 
      RowBox[{"[", "1", "]"}], "]"}], "=", 
     RowBox[{
      RowBox[{"psd1side", "[", 
       RowBox[{"[", "1", "]"}], "]"}], "/", "2"}]}], ";", " ", 
    "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"EvenQ", "[", "nPts", "]"}], ",", 
      RowBox[{
       RowBox[{"psd1side", "[", 
        RowBox[{"[", 
         RowBox[{"-", "1"}], "]"}], "]"}], "=", 
       RowBox[{
        RowBox[{"psd1side", "[", 
         RowBox[{"[", 
          RowBox[{"-", "1"}], "]"}], "]"}], "/", "2"}]}], ",", "Null"}], 
     "]"}], ";", "\[IndentingNewLine]", "psd1side"}], "\[IndentingNewLine]", 
   ")"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.411239998579794*^9, 3.411239999489706*^9}, {
   3.411240067426894*^9, 3.411240068195314*^9}, {3.411240105986431*^9, 
   3.411240124259521*^9}, {3.4112403605091963`*^9, 3.411240364018433*^9}, {
   3.4113067631808987`*^9, 3.411306804987101*^9}, {3.411306835163084*^9, 
   3.411306980996332*^9}, {3.4113071433742456`*^9, 3.411307148572413*^9}, {
   3.411307342206431*^9, 3.411307357564331*^9}, 3.4113074617374363`*^9, {
   3.411307597559155*^9, 3.4113076313960333`*^9}, {3.4113080583576183`*^9, 
   3.411308090844348*^9}, {3.411402252782298*^9, 3.411402276453919*^9}, {
   3.412684056366745*^9, 3.41268405659446*^9}, {3.412684278015317*^9, 
   3.412684295445634*^9}, {3.4127073003774853`*^9, 3.4127073021599483`*^9}, {
   3.4127074572950163`*^9, 3.412707457813971*^9}, {3.4160021152145157`*^9, 
   3.4160021311517067`*^9}}],

Cell[BoxData[
 RowBox[{"npts", "=."}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412684237308547*^9, 3.4126842406138783`*^9}, {
  3.416002115214767*^9, 3.416002131151937*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"test11", "=", 
   RowBox[{"{", 
    RowBox[{
    "1", ",", "2", ",", "3", ",", "4", ",", "5", ",", "6", ",", "7", ",", "8",
      ",", "9", ",", "10", ",", "11"}], "}"}]}], ";"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412684322775334*^9, 3.412684339078854*^9}, {
  3.412684408017812*^9, 3.412684414942602*^9}, {3.41600211562604*^9, 
  3.416002131152116*^9}}],

Cell[BoxData[
 RowBox[{"psd1", "[", 
  RowBox[{"test11", ",", "1."}], "]"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.41268434397716*^9, 3.412684359190206*^9}, {
  3.4126844188414383`*^9, 3.412684418998129*^9}, {3.416002115626315*^9, 
  3.4160021311523438`*^9}}],

Cell[BoxData["nPts"], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.41268436842759*^9, 3.412684375022086*^9}, {
  3.4160021156268883`*^9, 3.416002131152742*^9}}],

Cell[BoxData[
 RowBox[{"Length", "[", "psd2side", "]"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412684397832594*^9, 3.412684402686182*^9}, {
  3.416002115627379*^9, 3.4160021311531563`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Define a RMS function to compute rms from PSD data. Input arguments are: \
psd=name of PSD list; ntot=total points in source profile; delx= physical \
increment value for each data point step; lo and hi = index value in the PSD \
list.
NOTE: Need to know the length of the input z-vector for the ntot number. \
Can't get it from the length of the psd list. It should be the length of the \
psd2side list if this corresponds to the input psd list.\
\>", "Subsubsection",
 InitializationGroup->True,
 CellChangeTimes->{{3.411414167914678*^9, 3.411414349868288*^9}, {
  3.4126844561715612`*^9, 3.4126845856612263`*^9}, {3.416002115627934*^9, 
  3.4160021311536417`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"rmspsdIDX", "[", 
   RowBox[{"psd_", ",", "nztot_", ",", "delx_", ",", "lo_", ",", "hi_"}], 
   "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"rmsval", "=", 
     RowBox[{"N", "[", 
      SqrtBox[
       FractionBox[
        RowBox[{"Plus", "@@", 
         RowBox[{"Take", "[", 
          RowBox[{"psd", ",", 
           RowBox[{"{", 
            RowBox[{"lo", ",", "hi"}], "}"}]}], "]"}]}], 
        RowBox[{"nztot", " ", "delx"}]]], "]"}]}], ";", 
    RowBox[{"Print", "[", 
     RowBox[{
     "\"\<RMS over index range [\>\"", ",", "lo", ",", "\"\<,\>\"", ",", "hi",
       ",", "\"\<] = \>\"", ",", "rmsval"}], "]"}]}], ")"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.4113155483504143`*^9, 3.411315622652503*^9}, {
  3.411317944809703*^9, 3.411317959276698*^9}, {3.412361562891111*^9, 
  3.412361567170394*^9}, {3.412684184124906*^9, 3.412684191041706*^9}, {
  3.412693067127249*^9, 3.412693068546364*^9}, {3.416002115628377*^9, 
  3.416002131160344*^9}},
 AspectRatioFixed->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"rmspsd", "[", 
    RowBox[{"psd_", ",", "nztot_", ",", "delx_", ",", "lo_", ",", "hi_"}], 
    "]"}], ":=", 
   RowBox[{"N", "[", 
    SqrtBox[
     FractionBox[
      RowBox[{"Plus", "@@", 
       RowBox[{"Take", "[", 
        RowBox[{"psd", ",", 
         RowBox[{"{", 
          RowBox[{"lo", ",", "hi"}], "}"}]}], "]"}]}], 
      RowBox[{"nztot", " ", "delx"}]]], "]"}]}], ";"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412361576280429*^9, 3.412361608242882*^9}, {
  3.41269307849756*^9, 3.41269307919328*^9}, {3.412705457595612*^9, 
  3.412705460258893*^9}, {3.416002115628628*^9, 3.416002131160548*^9}}],

Cell["\<\
Now generalize the variance calculation to apply to zero-padded data to give \
the same result as for the original data set. Need to boost up each term \
separately.\
\>", "Text",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115628901*^9, 3.416002131160778*^9}},
 AspectRatioFixed->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"varGen", "[", 
   RowBox[{"anylist_", ",", "beforeLen_", ",", "afterLen_"}], "]"}], ":=", 
  RowBox[{"N", "[", 
   RowBox[{
    RowBox[{"sfac", "=", 
     FractionBox["afterLen", "beforeLen"]}], ";", 
    RowBox[{
     FractionBox[
      RowBox[{"sfac", " ", 
       RowBox[{"Plus", "@@", 
        SuperscriptBox["anylist", "2"]}]}], "afterLen"], "-", 
     RowBox[{
      SuperscriptBox["sfac", "2"], " ", 
      SuperscriptBox[
       RowBox[{"(", 
        FractionBox[
         RowBox[{"Plus", "@@", "anylist"}], "afterLen"], ")"}], "2"]}]}]}], 
   "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115629024*^9, 3.416002131161106*^9}},
 AspectRatioFixed->True],

Cell[BoxData[
 RowBox[{"sdevGen", "=", 
  SqrtBox[
   RowBox[{"varGen", "[", 
    RowBox[{"worklist", ",", "nbefore", ",", "nafter"}], "]"}]]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.4160021156291523`*^9, 3.416002131161407*^9}},
 AspectRatioFixed->True]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Add a point digitizer to a plot. Results are put into vector \"res\".\
\>", "Subsubsection",
 InitializationGroup->True,
 CellChangeTimes->{{3.4123536743985023`*^9, 3.4123537089052973`*^9}, {
  3.416002115629663*^9, 3.416002131161873*^9}}],

Cell[BoxData[
 StyleBox[
  RowBox[{
   RowBox[{"locatePts", "[", "plotname_", "]"}], ":=", "\[IndentingNewLine]", 
   
   RowBox[{"Block", "[", " ", 
    RowBox[{
     RowBox[{"{", "}"}], ",", " ", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"res", " ", "=", " ", 
       RowBox[{"{", "}"}]}], ";", " ", "\n", 
      RowBox[{"Dynamic", "[", "res", "]"}], ";", " ", "\n", "  ", 
      RowBox[{"EventHandler", "[", " ", "\n", "         ", 
       RowBox[{"plotname", ",", " ", 
        RowBox[{"{", 
         RowBox[{"\"\<MouseDown\>\"", " ", ":>", 
          RowBox[{"(", " ", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"res", ",", " ", 
             RowBox[{"MousePosition", "[", "\"\<Graphics\>\"", "]"}]}], "]"}],
            ")"}]}], "}"}]}], " ", "\n", "        ", "]"}]}]}], " ", "]"}]}],
  FontFamily->"Arial",
  FontWeight->"Plain"]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115629848*^9, 3.416002131162106*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
The following tick function rescales the axes labels from the default [xmin, \
xmax] range by offsetting the starting point by b and scaling the tick value \
by m. 
Note that you need to specify the AxesOrigin in terms of the unshifted \
function.\
\>", "Subsubsection",
 InitializationGroup->True,
 CellChangeTimes->{{3.4160021156301613`*^9, 3.416002131162328*^9}}],

Cell[BoxData[
 RowBox[{"$TextStyle", "=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"FontFamily", "\[Rule]", "Arial"}], ",", 
    RowBox[{"FontSize", "\[Rule]", "10"}]}], "}"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.4123695656164*^9, 3.4123695691646137`*^9}, {
  3.412369655031846*^9, 3.4123696561967983`*^9}, {3.41270549425765*^9, 
  3.41270550381952*^9}, {3.416002115630471*^9, 3.4160021311625566`*^9}}],

Cell[BoxData[
 RowBox[{"Style", "[", 
  RowBox[{"PlotLabel", ",", 
   RowBox[{"DefaultOptions", "->", 
    RowBox[{"{", 
     RowBox[{"FontFamily", "->", "Arial"}], "}"}]}]}], "]"}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.412705739454899*^9, 3.412705835393314*^9}, {
  3.416002115630872*^9, 3.416002131162959*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"tickf", "[", 
   RowBox[{"min_", ",", "max_", ",", "m_", ",", "b_", ",", "step_"}], "]"}], ":=",
   " ", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"i", ",", 
      RowBox[{"m", " ", 
       RowBox[{"(", 
        RowBox[{"i", "-", "b"}], ")"}]}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "min", ",", "max", ",", "step"}], "}"}]}], 
   "]"}]}]], "Input",
 InitializationGroup->True,
 CellChangeTimes->{{3.416002115631175*^9, 3.416002131163348*^9}}],

Cell["File name conventions", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"filename", "=."}], ";", 
  RowBox[{"filenamefull", "=."}], ";", 
  RowBox[{"fnames", "=."}], ";", 
  RowBox[{"plotname", "=."}], ";", 
  RowBox[{"filepath", "=."}], ";", 
  RowBox[{"filepathfull", "=."}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"filein", "=."}], ";", 
  RowBox[{"fileinroot", "=."}], ";", 
  RowBox[{"fileinS", "=."}], ";"}]], "Input"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["\<\
Full automated run starts here. Just answer the questions and the nb will run \
to completion and output all of the data products to the woring directory.\
\>", "Section"],

Cell[CellGroupData[{

Cell["Execute following after setting the proper file path.", "Subsubsection"],

Cell[BoxData[
 RowBox[{"filepathfull", " "}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"filepathfull", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<Do Insert->FilePath and navigate to desired data file and select to \
enter here.\>\"", ",", "filepathfull"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SetDirectory", "[", 
  RowBox[{"DirectoryName", "[", "filepathfull", "]"}], "]"}]], "Input"],

Cell["\<\
Use the filename form appropriate for the computer platform, either MacOSX or \
Windows\
\>", "Text"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"$OperatingSystem", "==", "\"\<Windows\>\""}], ",", 
    RowBox[{"sep$", "=", "\"\<\\\\\>\""}], ",", 
    RowBox[{"sep$", "=", "\"\</\>\""}]}], "]"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"manualcalcFlag", "=", "False"}], ";"}], " ", 
  RowBox[{"(*", 
   RowBox[{"set", " ", "for", " ", "automated", " ", "analysis"}], 
   "*)"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"manualcalcFlag", "=", "True"}], ";"}], "*)"}], " ", 
  RowBox[{"(*", 
   RowBox[{
   "to", " ", "stop", " ", "automated", " ", "analysis", " ", "with", " ", 
    "default", " ", "parameters"}], "*)"}]}]], "Input",
 CellChangeTimes->{{3.64401191212829*^9, 3.644011917846917*^9}}]
}, Open  ]],

Cell["\<\
Enter upstemcal offset value here, for later correction of CCD absolute \
height relative to REF plane.\
\>", "Subsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"upstemcal", "=", "0.0"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"upstemcal", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<Enter upstemcal offset factor here. Default = 0\>\"", ",", 
    "upstemcal"}], "]"}]}]], "Input"],

Cell[CellGroupData[{

Cell["\<\
Read in OGP  txt format. Contours. This is treated as FREEFORM data, i.e. no \
set nrows or ncols.\
\>", "Subsection"],

Cell["\<\
Data is in the form of a big list of triplets in units of mm. The X,Y \
coordinate is included with the z-value. Note that this is NOT a rectangular \
data array, so can't use the array plot functions unless the data is padded \
to make a grid, which is not possible with OGP freefom data.\
\>", "Text"],

Cell[BoxData[
 RowBox[{"SetDirectory", "[", 
  RowBox[{"DirectoryName", "[", "filepathfull", "]"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"datain", "=."}], ";", 
   RowBox[{"datain2", "=."}], ";", 
   RowBox[{"datainXYZSR", "=."}], ";", 
   RowBox[{"skipnum", "=."}], ";", 
   RowBox[{"nRows", "=."}], ";", 
   RowBox[{"nCols", "=."}], ";", 
   RowBox[{"delx", "=."}], ";", " ", 
   RowBox[{"dely", "=."}], ";"}], 
  RowBox[{"(*", 
   RowBox[{"nominal", " ", "scan", " ", "values"}], " ", "*)"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"fnames", "=", 
   RowBox[{"FileNames", "[", "\"\<*.DAT\>\"", "]"}]}], ";", 
  RowBox[{
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"fnames", "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "fnames", "]"}]}], "}"}]}], "]"}], "//", 
   "TableForm"}]}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"Table", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"i", ",", 
     RowBox[{"fnames", "[", 
      RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"i", ",", 
     RowBox[{"Length", "[", "fnames", "]"}]}], "}"}]}], "]"}]], "Input"],

Cell[CellGroupData[{

Cell["Pick the OGP file from the list", "Subsubsection",
 CellTags->"pick MST file num"],

Cell[BoxData[
 RowBox[{"inst$", "=", "\"\<OGP\>\""}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"nf", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
    RowBox[{"TemplateApply", "[", 
     RowBox[{
     "StringTemplate", "[", 
      "\"\<Enter index of desired file in the list \
(0=Abort):\\n<*Table[{i,fnames[[i]]},{i,Length[fnames]}]//TableForm*>\>\"", 
      "]"}], "]"}], ",", "nf"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"nf", "<", "1"}], ",", 
   RowBox[{
    RowBox[{
    "MessageDialog", "[", 
     "\"\<Incorrect file number. Abort the run, please.\>\"", "]"}], ";", 
    RowBox[{"Interrupt", "[", "]"}], ";", 
    RowBox[{"Abort", "[", "]"}]}]}], "]"}]], "Input"],

Cell[BoxData[{
 RowBox[{"fileinfull", " ", "=", 
  RowBox[{"fnames", "[", 
   RowBox[{"[", "nf", "]"}], "]"}]}], "\n", 
 RowBox[{"fileinroot", "=", 
  RowBox[{"FileBaseName", "[", "fileinfull", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"fileinS", "=", "fileinroot"}], ";"}]}], "Input",
 CellAutoOverwrite->False],

Cell["There is no separate REF file, so set filein to fileinS", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"filein", "=", "fileinS"}], ";", 
  RowBox[{"datain", "=", 
   RowBox[{"Import", "[", 
    RowBox[{"fileinfull", ",", "\"\<Data\>\""}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{"manualcalcFlag", ",", 
    RowBox[{"Interrupt", "[", "]"}]}], " ", "]"}], 
  RowBox[{"(*", " ", 
   RowBox[{
   "Stop", " ", "here", " ", "to", " ", "execute", " ", "next", " ", 
    "expressons", " ", "individually", " ", "as", " ", "needed", " ", "to", 
    " ", "clean", " ", "up", " ", "data"}], " ", "*)"}]}]], "Input"],

Cell[CellGroupData[{

Cell["Create subdir for data file output", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Directory", "[", "]"}], "  ", 
  RowBox[{"(*", " ", 
   RowBox[{
   "This", " ", "is", " ", "the", " ", "current", " ", "default", " ", 
    "directory"}], " ", "*)"}]}], "\n", 
 RowBox[{"workdir", "=", 
  RowBox[{"filein", "<>", "\"\<_files\>\""}]}]}], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"!", 
    RowBox[{"DirectoryQ", "[", "workdir", "]"}]}], ",", 
   RowBox[{
    RowBox[{"CreateDirectory", "[", "workdir", "]"}], ";", 
    RowBox[{"Print", "[", "\"\<New work dir created\>\"", "]"}]}], ",", 
   RowBox[{"Print", "[", 
    RowBox[{
    "workdir", "<>", "\"\< already exists. Using it for output.\>\""}], 
    "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"SetDirectory", "[", "workdir", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"]
}, Open  ]],

Cell["\<\
Strip out all of the Contour record, nulls and EORs, making one long list of \
points.\
\>", "Text"],

Cell[BoxData[{
 RowBox[{"Length", "[", "datain", "]"}], "\n", 
 RowBox[{
  RowBox[{"Count", "[", 
   RowBox[{"datain", ",", 
    RowBox[{"{", "}"}]}], "]"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
   "Counts", " ", "the", " ", "number", " ", "of", " ", "blank", " ", 
    "records", " ", "in", " ", "the", " ", "file"}], "*)"}]}]}], "Input"],

Cell[CellGroupData[{

Cell["Replace this with new contour finder", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"datain2", "=", 
    RowBox[{"Select", "[", 
     RowBox[{"datain", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "[", "#", "]"}], ">", "0"}], "&"}]}], "]"}]}], 
   ";"}], 
  RowBox[{"(*", 
   RowBox[{"Strip", " ", "out", " ", "the", " ", "blank", " ", "lines"}], 
   "*)"}]}]], "Input"],

Cell[BoxData[{
 RowBox[{"contourPos", "=", 
  RowBox[{"Position", "[", 
   RowBox[{"datain2", ",", "\"\<Contour\>\"", ",", "2"}], "]"}]}], "\n", 
 RowBox[{"Length", "[", "contourPos", "]"}]}], "Input"],

Cell[BoxData[{
 RowBox[{"Length", "[", "datain2", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"datain2", "=", 
    RowBox[{"Select", "[", 
     RowBox[{"datain2", ",", 
      RowBox[{
       RowBox[{"NumericQ", "[", 
        RowBox[{"#", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}], "&"}]}], "]"}]}], ";"}], " ", 
  
  RowBox[{"(*", " ", 
   RowBox[{
   "Strip", " ", "out", " ", "all", " ", "the", " ", "lines", " ", "that", 
    " ", 
    RowBox[{"don", "'"}], "t", " ", "start", " ", "with", " ", "a", " ", 
    "number"}], " ", "*)"}]}], "\n", 
 RowBox[{"Length", "[", "datain2", "]"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"datain2", "[", 
    RowBox[{"[", 
     RowBox[{"1", ";;", "10"}], "]"}], "]"}], "//", "TableForm"}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"manualcalcFlag", ",", 
   RowBox[{"Interrupt", "[", "]"}]}], " ", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"Manipulate", "[", 
  RowBox[{
   RowBox[{"datain2", "[", 
    RowBox[{"[", "i", "]"}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"i", ",", "1", ",", 
     RowBox[{"Length", "[", "datain2", "]"}], ",", "1"}], "}"}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.644009408198921*^9, 3.644009457519156*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Strip out all but the Contour points", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"Length", "[", "datain", "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"Dimensions", "[", "datain", "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"datain", "[", 
  RowBox[{"[", 
   RowBox[{"1", ";;", "10"}], "]"}], "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"datain", "[", 
  RowBox[{"[", 
   RowBox[{
    RowBox[{"-", "10"}], ";;", 
    RowBox[{"-", "1"}]}], "]"}], "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"Length", "[", "datain", "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell["\<\
Find all lines with less than 2 numbers and at least 1 string. This excludes \
all the the triplet lines with mm at the end.\
\>", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"charpos", "=", 
   RowBox[{"Reap", "[", 
    RowBox[{"Do", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Count", "[", 
            RowBox[{
             RowBox[{"datain", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"_", "?", "NumberQ"}]}], "]"}], "<", "2"}], "&&", 
          RowBox[{
           RowBox[{"Count", "[", 
            RowBox[{
             RowBox[{"datain", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"_", "?", "StringQ"}]}], "]"}], ">=", "1"}]}], ")"}], 
        ",", 
        RowBox[{"Sow", "[", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1"}], "}"}], "]"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", "datain", "]"}]}], "}"}]}], "]"}], "]"}]}], 
  ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"charpos", "[", 
   RowBox[{"[", 
    RowBox[{"2", ",", "1"}], "]"}], "]"}], "//", "Length"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"Drop", "[", 
   RowBox[{"charpos", ",", "1"}], "]"}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"charpos2", "=", 
  RowBox[{"Flatten", "[", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{"charpos", ",", "1"}], "]"}], ",", "2"}], "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"charpos3", "=", 
  RowBox[{"Map", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Part", "[", 
      RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", "charpos2", ",", "1"}], 
   "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "Find", " ", "all", " ", "the", " ", "record", " ", "numbers", " ", 
    "where", " ", "Contour", " ", "occurs"}], "*)"}], 
  RowBox[{"cpos", "=", 
   RowBox[{"Position", "[", 
    RowBox[{
     RowBox[{"Extract", "[", 
      RowBox[{"datain", ",", "charpos2"}], "]"}], ",", "\"\<Contour\>\""}], 
    "]"}]}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"cpos", "+", "1", "  ", 
  RowBox[{"(*", 
   RowBox[{
   "Add", " ", "1", " ", "to", " ", "specify", " ", "the", " ", "record", " ",
     "following", " ", "the", " ", "Contour", " ", "record"}], 
   "*)"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"rifflvec", "=", 
  RowBox[{"Riffle", "[", 
   RowBox[{"cpos", ",", 
    RowBox[{"cpos", "+", "1"}]}], "]"}], " ", 
  RowBox[{"(*", 
   RowBox[{"Combine", " ", "the", " ", "2", " ", "vectors"}], 
   "*)"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
  "Now", " ", "pull", " ", "out", " ", "the", " ", "index", " ", "locations", 
   " ", "from", " ", "charpos2", " ", "pointed", " ", "to", " ", "by", " ", 
   "the", " ", "riffled", " ", "vector"}], "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"cpairs", "=", 
  RowBox[{
   RowBox[{
    RowBox[{"Extract", "[", 
     RowBox[{"charpos2", ",", "rifflvec"}], "]"}], "//", 
    RowBox[{
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Part", "[", 
         RowBox[{"#", ",", "1"}], "]"}], "&"}], ",", "#", ",", "1"}], "]"}], 
     "&"}]}], "//", 
   RowBox[{
    RowBox[{"Partition", "[", 
     RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell["\<\
Enter a specific list of desired regions as the iterator for the Do loop.\
\>", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
   "Now", " ", "take", " ", "the", " ", "range", " ", "of", " ", "points", 
    " ", "from", " ", "datain", " ", "between", " ", "the", " ", "range", " ", 
    RowBox[{"pairs", ".", " ", "Drop"}], " ", "the", " ", "first", " ", 
    "record", " ", "in", " ", "each", " ", "range", " ", 
    RowBox[{"(", "Contour"}]}], "}"}], "*)"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"datain4", "=."}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"datain4", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"Reap", "[", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"Sow", "[", 
         RowBox[{"Take", "[", 
          RowBox[{"datain", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"cpairs", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "1"}], "]"}], "]"}], "+", "1"}], ",", 
             RowBox[{
              RowBox[{"cpairs", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "2"}], "]"}], "]"}], "-", "2"}]}], "}"}]}], 
          "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "cpairs", "]"}]}], "}"}]}], "]"}], 
      "\[IndentingNewLine]", "]"}], "//", 
     RowBox[{
      RowBox[{"Drop", "[", 
       RowBox[{"#", ",", "1"}], "]"}], "&"}]}], "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "3"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"Length", "[", "datain4", "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"datain2", "=", "datain4"}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],

Cell["\<\
All data points are now in one continuous list. All the contours are merged \
together\
\>", "Subsubsection"],

Cell[CellGroupData[{

Cell["continue here", "Subsubsection",
 CellTags->"data ready"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"datain3x", "=", 
    RowBox[{"Take", "[", 
     RowBox[{"datain2", ",", "All", ",", "3"}], "]"}]}], ";"}], 
  RowBox[{"(*", " ", 
   RowBox[{"Strip", " ", "off", " ", "the", " ", "XYZ", " ", "numbers"}], 
   "*)"}]}]], "Input"],

Cell["Convert z-vals to microns:", "Text"],

Cell[BoxData[{
 RowBox[{"datain3x", "[", 
  RowBox[{"[", "1", "]"}], "]"}], "\n", 
 RowBox[{
  RowBox[{"datain3x", "=", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"MapAt", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Times", "[", 
          RowBox[{"#", ",", 
           RowBox[{"10", "^", "3"}]}], "]"}], "&"}], ",", "#", ",", "3"}], 
       "]"}], "&"}], ",", "datain3x"}], "]"}]}], ";"}], "\n", 
 RowBox[{"datain3x", "[", 
  RowBox[{"[", "1", "]"}], "]"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"xunit$", "=", "\"\<mm\>\""}], ";", 
   RowBox[{"yunit$", "=", "\"\<mm\>\""}], ";", 
   RowBox[{"zunit$", "=", "\"\<\[Micro]m\>\""}], ";"}], " ", 
  RowBox[{"(*", 
   RowBox[{"These", " ", "are", " ", "now", " ", "current", " ", "units"}], 
   "*)"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[{
 RowBox[{
  RowBox[{"datainXYZS", "=", "datain3x"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"datainXYZSR", "=", "datainXYZS"}], ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"No", " ", 
    RowBox[{"REF", ".", " ", "Copy"}], " ", "surface", " ", "into", " ", "SR",
     " ", 
    RowBox[{"array", "."}]}], " ", "*)"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"skipnum", "=."}], ";", 
  RowBox[{"cloudXYZ", "=."}]}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"cloudXYZ", "=", "datainXYZSR"}], ";"}], "\n", 
 RowBox[{"Dimensions", "[", "cloudXYZ", "]"}]}], "Input"]
}, Open  ]],

Cell["Range of raw z-values:", "Text"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Min", "[", 
    RowBox[{"cloudXYZ", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", 
       RowBox[{"{", "3", "}"}]}], "]"}], "]"}], "]"}], ",", 
   RowBox[{"Max", "[", 
    RowBox[{"cloudXYZ", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", 
       RowBox[{"{", "3", "}"}]}], "]"}], "]"}], "]"}]}], "}"}]], "Input"],

Cell[CellGroupData[{

Cell["Plot free-form data list not on uniform grid", "Subsection"],

Cell["\<\
Start next range clean-up here. Keep eliminating points from cloudXYZ based \
on x and y and z range criteria.\
\>", "Subsubsection",
 CellTags->"XY range restriction start"],

Cell["\<\
Execute the appropriate unpacking expression and rearrange the cloudXYZ as \
necessary.
This depends on the ordering of the XYZ values in each triplet:  XYZ or ZYX\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"xvals", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"cloudXYZ", ",", "All", ",", 
      RowBox[{"{", "1", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"yvals", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"cloudXYZ", ",", "All", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"zvals", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"cloudXYZ", ",", "All", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}]}], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"xmin", "=", 
     RowBox[{"Min", "[", "xvals", "]"}]}], ",", 
    RowBox[{"xmax", "=", 
     RowBox[{"Max", "[", "xvals", "]"}]}]}], "}"}], "//", 
  "N"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"ymin", "=", 
     RowBox[{"Min", "[", "yvals", "]"}]}], ",", 
    RowBox[{"ymax", "=", 
     RowBox[{"Max", "[", "yvals", "]"}]}]}], "}"}], "//", 
  "N"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"zmin", "=", 
     RowBox[{"Min", "[", "zvals", "]"}]}], ",", 
    RowBox[{"zmax", "=", 
     RowBox[{"Max", "[", "zvals", "]"}]}], ",", 
    RowBox[{"Mean", "[", "zvals", "]"}], ",", 
    RowBox[{"StandardDeviation", "[", "zvals", "]"}]}], "}"}], "//", 
  "N"}]}], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"deltaX", "=", 
    RowBox[{"xmax", "-", "xmin"}]}], ",", " ", 
   RowBox[{"deltaY", "=", 
    RowBox[{"ymax", "-", "ymin"}]}], ",", 
   RowBox[{"deltaZ", "=", 
    RowBox[{"zmax", "-", "zmin"}]}]}], "}"}]], "Input"],

Cell[BoxData[
 RowBox[{"rowscols$", "=", "\"\<cloud\>\"", " ", 
  RowBox[{"(*", "\"\<sparse\>\"", "*)"}]}]], "Input"],

Cell["\<\
Next expression may not contain desired array on first pass. Why???? BEWARE\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"vp", "=", 
   RowBox[{"{", 
    RowBox[{"0", ",", 
     RowBox[{"-", "2"}], ",", "2"}], "}"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Dynamic", "[", "vp", "]"}], ";"}]}], "Input",
 CellChangeTimes->{{3.6440090598306847`*^9, 3.64400916593165*^9}, {
  3.644009241929307*^9, 3.644009246469157*^9}, {3.644009290874243*^9, 
  3.6440092910618677`*^9}}],

Cell[BoxData[
 RowBox[{"Dimensions", "[", "cloudXYZ", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"lpp01", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"cloudXYZ", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "\[Rule]", "vp"}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "->", "400"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nraw data\>\""}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.64400926683454*^9, 3.644009267013892*^9}}],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_SUTandREFraw.tiff\>\""}], ",", "lpp01", 
     ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export raw data SUT&REF plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_SUTandREFraw.tiff\>\""}], ",", "lpp01", 
      ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "\[Rule]", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[CellGroupData[{

Cell["Find the SUT and REF ", "Subsubsection"],

Cell[BoxData[
 RowBox[{"xyPCSrange", "=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"0.", ",", "45."}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "35."}], ",", "75."}], "}"}]}], "}"}]}]], "Input"],

Cell["\<\
First discard the points in the MCS that are measured before the datum origin \
defining the PCS is set on the hole center.\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"xminPCS", ",", "xmaxPCS"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"yminPCS", ",", "ymaxPCS"}], "}"}]}], "}"}], "=", 
  "xyPCSrange"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"testRegion", " ", "=", 
   RowBox[{"Reap", "[", " ", 
    RowBox[{"Do", "[", 
     RowBox[{
      RowBox[{"If", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"cloudXYZ", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "<", "xmaxPCS"}], "&&", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"cloudXYZ", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], ">", "xminPCS"}], "&&", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"cloudXYZ", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "<", "ymaxPCS"}], "&&", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"cloudXYZ", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], ">", "yminPCS"}], "&&", 
         RowBox[{
          RowBox[{
           RowBox[{"cloudXYZ", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ">", "1000."}]}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"Sow", "[", 
         RowBox[{"cloudXYZ", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", "cloudXYZ", "]"}]}], "}"}]}], "]"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"PCSregion", "=", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{"testRegion", ",", "1"}], "]"}], "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}], "\n", 
 RowBox[{"Length", "[", "PCSregion", "]"}]}], "Input"],

Cell["Verify that the proper region has been selected.", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"PCSregionplt", "=", 
   RowBox[{"ListPointPlot3D", "[", 
    RowBox[{"PCSregion", ",", 
     RowBox[{"PlotRange", "->", "All"}], ",", 
     RowBox[{"ViewPoint", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "Infinity"}], "}"}]}], ",", 
     RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
     RowBox[{"ImageSize", "->", "400"}], ",", 
     RowBox[{"AxesLabel", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], 
       "}"}]}], ",", 
     RowBox[{"PlotLabel", "->", 
      RowBox[{"fileinS", "<>", "\"\<\\nPCSregion\>\""}]}]}], "]"}]}], 
  ";"}]], "Input"]
}, Open  ]],

Cell["\<\
Isolate the CCD region. THis will define the inclusion limits in Y-dir for \
dividing the data into REF and SUT regions.\
\>", "Text"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"manualcalcFlag", ",", 
   RowBox[{
   "Input", "[", 
    "\"\<Abort and set sliders now to isolate CCD surface region, then \
execute next section.\>\"", "]"}], ",", 
   RowBox[{
   "Input", "[", "\"\<Auto calc sets SUT range automatically\>\"", "]"}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.6440114336700497`*^9, 3.644011482926113*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Fix the xyrange to isolate the SUT region from the REF surfaces. Requires the \
datum origin to be at the CDD LL corner.\
\>", "Subsubsection"],

Cell[BoxData[
 RowBox[{"xyrange", "=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"0.", ",", "45."}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"0.", ",", "45."}], "}"}]}], "}"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"xminCCD", ",", "xmaxCCD"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"yminCCD", ",", "ymaxCCD"}], "}"}]}], "}"}], "=", 
  "xyrange"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"imin", ",", "imax"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"jmin", ",", "jmax"}], "}"}]}], "}"}], "=."}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"xminCCD", ",", "xmaxCCD"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"yminCCD", ",", "ymaxCCD"}], "}"}]}], "}"}], "//", 
  "TableForm"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False]
}, Open  ]],

Cell[CellGroupData[{

Cell["Now separate the point cloud into 2 regions: SUT and REF", "Subsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"testS", "=."}], ";", 
  RowBox[{"testR", "=."}], ";", 
  RowBox[{"SUTdata", "=."}], ";", 
  RowBox[{"REFdata", "=."}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"testS", " ", "=", 
   RowBox[{"Reap", "[", "\[IndentingNewLine]", " ", 
    RowBox[{"Do", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"PCSregion", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "<", "xmaxCCD"}], "&&", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"PCSregion", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], ">", "xminCCD"}], "&&", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"PCSregion", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "<", "ymaxCCD"}], "&&", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"PCSregion", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], ">", "yminCCD"}]}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"Sow", "[", 
         RowBox[{
          RowBox[{"PCSregion", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", "x"}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"Sow", "[", 
         RowBox[{
          RowBox[{"PCSregion", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", "y"}], "]"}]}], 
       "\[IndentingNewLine]", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", "PCSregion", "]"}]}], "}"}]}], 
     "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"SUTdata", "=", 
   RowBox[{"testS", "[", 
    RowBox[{"[", 
     RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"REFdata", " ", "=", " ", 
   RowBox[{"testS", "[", 
    RowBox[{"[", 
     RowBox[{"2", ",", "2"}], "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Length", "[", "SUTdata", "]"}], ",", 
   RowBox[{"Length", "[", "REFdata", "]"}]}], "}"}], "\n", 
 RowBox[{
  RowBox[{"tests", "=."}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{"splt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"SUTdata", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "\[Rule]", "200"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nraw SUT region\>\""}]}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"rplt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"REFdata", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "\[Rule]", "200"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nraw REF region\>\""}]}]}], 
   "]"}]}]], "Input"]
}, Open  ]],

Cell["\<\
Now work on Flatness of SUT. Remove tilt with plane fit and trim bad points \
from residuals.\
\>", "Section"],

Cell[CellGroupData[{

Cell["\<\
Clean up SUT points, removing outliers. MUST EXECUTE THIS SECTION.\
\>", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"fitbasis", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "x", ",", "y"}], "}"}]}], ";", 
  RowBox[{"fitidx", "=", "\"\<1,1\>\""}], ";"}], "\n", 
 RowBox[{"fitord$", "=", 
  RowBox[{"StringTake", "[", 
   RowBox[{
    RowBox[{"ToString", "[", "fitbasis", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"2", ",", 
      RowBox[{"-", "2"}]}], "}"}]}], "]"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SUTfit", "[", 
   RowBox[{"x_", ",", "y_"}], "]"}], "=", 
  RowBox[{"Fit", "[", 
   RowBox[{"SUTdata", ",", "fitbasis", ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "y"}], "}"}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"vp1", "=", 
   RowBox[{"{", 
    RowBox[{"2", ",", "0", ",", ".5"}], "}"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"sutfitplt", "=", 
   RowBox[{"Plot3D", "[", 
    RowBox[{
     RowBox[{"SUTfit", "[", 
      RowBox[{"x", ",", "y"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", "xminCCD", ",", "xmaxCCD"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", ",", "ymin", ",", "ymax"}], "}"}], ",", 
     RowBox[{"ColorFunction", "->", "\"\<Rainbow\>\""}], ",", 
     RowBox[{"ImageSize", "\[Rule]", "400"}], ",", 
     RowBox[{"PlotStyle", "->", 
      RowBox[{"Opacity", "[", "0.5", "]"}]}], ",", 
     RowBox[{"ViewPoint", "->", 
      RowBox[{"Dynamic", "[", "vp1", "]"}]}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"SUTandFITplane", "=", 
  RowBox[{"Show", "[", 
   RowBox[{"splt", ",", "sutfitplt", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp1", "]"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<\\nPlane fit to trimmed SUT points\>\""}]}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"Dynamic", "[", "vp1", "]"}]], "Input"],

Cell[CellGroupData[{

Cell["\<\
Now trim outliers more than some value away fom the fit plane value.
First subtract plane fit to the full SUT data. NEW VERSION for flatnees stats\
\
\>", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SUTresids", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"SUTdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
       RowBox[{"SUTdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"SUTdata", "[", 
         RowBox[{"[", 
          RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
        RowBox[{"SUTfit", "[", 
         RowBox[{
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{"Length", "[", "SUTresids", "]"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"SUTresidsZ", "=", 
    RowBox[{
     RowBox[{"SUTresids", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", 
        RowBox[{"{", "3", "}"}]}], "]"}], "]"}], "//", "Flatten"}]}], ";"}], 
  " ", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"extract", " ", "the", " ", "z"}], "-", "values"}], 
   "*)"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"Mean", "[", "SUTresidsZ", "]"}], ",", 
   RowBox[{"Median", "[", "SUTresidsZ", "]"}], ",", 
   RowBox[{"StandardDeviation", "[", "SUTresidsZ", "]"}]}], "}"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"minz", ",", "maxz"}], "}"}], "=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"Min", "[", "SUTresidsZ", "]"}], ",", 
    RowBox[{"Max", "[", "SUTresidsZ", "]"}]}], "}"}]}]], "Input",
 CellChangeTimes->{{3.648846572408309*^9, 3.648846617154477*^9}}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"sutflathist", "=", 
  RowBox[{"Histogram", "[", "SUTresidsZ", "]"}], 
  RowBox[{"(*", 
   RowBox[{
   "These", " ", "are", " ", "the", " ", "residuals", " ", "after", " ", 
    "removing", " ", "plane", " ", "fit"}], "*)"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[CellGroupData[{

Cell["Trim the outliers here.", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"threshmin", ",", "threshmax"}], "}"}], "=", 
   RowBox[{"{", 
    RowBox[{"minz", ",", "maxz"}], "}"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.648846683032147*^9, 3.648846685144195*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"threshmin", ",", "threshmax"}], "}"}], "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<Enter {min,max} threshold values for trimming bad points.\>\"", ",", 
    RowBox[{"{", 
     RowBox[{"threshmin", ",", "threshmax"}], "}"}]}], "]"}]}]], "Input"],

Cell["Trim both the XYZ and the Z data lists", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SUTresidsZtrim", "=", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Drop", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Reap", "[", " ", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"SUTdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"SUTfit", "[", 
               RowBox[{
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "<", 
             "threshmax"}], " ", "&&", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"SUTdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"SUTfit", "[", 
               RowBox[{
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], ">", 
             "threshmin"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"Sow", "[", 
            RowBox[{
             RowBox[{"SUTdata", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
             RowBox[{"SUTfit", "[", 
              RowBox[{
               RowBox[{"SUTdata", "[", 
                RowBox[{"[", 
                 RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
               RowBox[{"SUTdata", "[", 
                RowBox[{"[", 
                 RowBox[{"i", ",", "2"}], "]"}], "]"}]}], " ", "]"}]}], 
            "]"}]}], "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], 
        "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "]"}], "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"SUTresidsZtrim", "[", 
  RowBox[{"[", 
   RowBox[{"1", ";;", "10"}], "]"}], "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SUTdatatrim", "=", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Drop", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Reap", "[", "\[IndentingNewLine]", " ", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"SUTdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"SUTfit", "[", 
               RowBox[{
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "<", 
             "threshmax"}], " ", "&&", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"SUTdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"SUTfit", "[", 
               RowBox[{
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"SUTdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], ">", 
             "threshmin"}]}], ",", 
           RowBox[{"Sow", "[", 
            RowBox[{"SUTdata", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
          "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], "]"}], 
       "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", "1"}], "]"}],
     "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SUTresidsXYZtrim", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"SUTdatatrim", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
       RowBox[{"SUTdatatrim", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
       RowBox[{"SUTresidsZtrim", "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "SUTdatatrim", "]"}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],

Cell["\<\
Use these SUT zresids for Flatness statistics. This excludes tilt effects and \
only looks at intrinsic surface flatness.\
\>", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxzF", "=", 
   RowBox[{"Max", "[", "SUTresidsZtrim", "]"}]}], ";", 
  RowBox[{"minzF", "=", 
   RowBox[{"Min", "[", "SUTresidsZtrim", "]"}]}], ";", 
  RowBox[{"sigmaF", "=", 
   RowBox[{"StandardDeviation", "[", "SUTresidsZtrim", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"zbinF", "=", 
   RowBox[{"BinCounts", "[", 
    RowBox[{"SUTresidsZtrim", ",", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"maxzF", "-", "minzF"}], ")"}], "/", "25"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"hrange", "[", 
    RowBox[{"binlist_", ",", "min_", ",", "max_"}], "]"}], ":=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"binlist", ",", 
     RowBox[{"{", 
      RowBox[{"min", ",", "max"}], "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"hgtrangeF95", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"SUTresidsZtrim", ",", "0.025", ",", "0.975"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"PVrangeF95", "=", 
   RowBox[{
    RowBox[{"hgtrangeF95", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrangeF95", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"hgtrangeF99", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"SUTresidsZtrim", ",", "0.005", ",", "0.995"}], "]"}]}], ";", 
  RowBox[{"PVrangeF99", "=", 
   RowBox[{
    RowBox[{"hgtrangeF99", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrangeF99", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"sigmaF", "//", 
   RowBox[{
    RowBox[{"NumberForm", "[", 
     RowBox[{"#", ",", "5"}], "]"}], "&"}]}], ";"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"vp1", "=", 
  RowBox[{"{", 
   RowBox[{"2", ",", "0", ",", ".5"}], "}"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"sutflatplt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"SUTresidsXYZtrim", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp1", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "\[Rule]", "600"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{
      "\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<Z [\[Micro]m]\>\""}], 
      "}"}]}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<: SUT flatness\>\"", "<>", "\"\<\\n95%range=\>\"", 
      "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\n99%range=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF99", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV99= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\nsdev=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaF", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}]}], "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_plot.tiff\>\""}], ",", 
     "sutflatplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export trimmed SUT region plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_plot.tiff\>\""}], ",", 
      "sutflatplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "->", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"Dynamic", "[", "vp1", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"sutlen$", "=", 
  RowBox[{"ToString", "[", 
   RowBox[{"Length", "[", "SUTresidsXYZtrim", "]"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_plot.tiff\>\""}], ",", 
     "sutflatplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export SUT Flatness plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_plot.tiff\>\""}], ",", 
      "sutflatplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"sutflathist", "=", 
  RowBox[{"Histogram", "[", 
   RowBox[{"SUTresidsZtrim", ",", "20", ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<: SUT flatness\>\"", "<>", "\"\<\\n95%range=\>\"", 
      "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\n99%range=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF99", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV99= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\nsdev=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaF", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}]}], "]"}], 
  RowBox[{"(*", 
   RowBox[{
   "These", " ", "are", " ", "the", " ", "residuals", " ", "after", " ", 
    "removing", " ", "plane", " ", "fit"}], "*)"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_histo.tiff\>\""}], ",", 
     "sutflathist", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export SUT Flatness histogram\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_histo.tiff\>\""}], ",", 
      "sutflathist", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "\[Rule]", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"sbwcF", "=", 
  RowBox[{"BoxWhiskerChart", "[", 
   RowBox[{"SUTresidsZtrim", ",", 
    RowBox[{"{", 
     RowBox[{"\"\<Outliers\>\"", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<MeanMarker\>\"", ",", "1.0", ",", "Thick"}], "}"}]}], 
     "}"}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<: SUT flatness\>\"", "<>", "\"\<\\n95%range=\>\"", 
      "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\n99%range=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF99", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV99= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\nsdev=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaF", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$"}]}], 
    ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"zunit$", ",", "\"\<\>\""}], "}"}]}]}], "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_bw.tiff\>\""}], ",", "sbwcF", 
     ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export Flatness whisker chart file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_bw.tiff\>\""}], ",", "sbwcF", 
      ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"quantlist", "=", 
   RowBox[{"Reverse", "[", 
    RowBox[{"{", 
     RowBox[{
     "0.0", ",", "0.005", ",", "0.01", ",", "0.025", ",", "0.25", ",", "0.50",
       ",", "0.75", ",", "0.975", ",", "0.99", ",", "0.995", ",", "1.0"}], 
     "}"}], "]"}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"qresF", "=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"SUTresidsZtrim", ",", "quantlist"}], "]"}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"qtableF", "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{"{", 
     RowBox[{"quantlist", ",", "qresF"}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"%", "//", "TableForm"}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_quantile.xlsx\>\""}], ",", 
     RowBox[{"Prepend", "[", 
      RowBox[{"qtableF", ",", 
       RowBox[{"{", 
        RowBox[{"fileinS", "<>", "\"\<, SUT flatness Quantiles\>\""}], 
        "}"}]}], "]"}], ",", "\"\<XLSX\>\""}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export Flatness Quantile table file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_quantile.xlsx\>\""}], ",", 
      RowBox[{"Prepend", "[", 
       RowBox[{"qtableF", ",", 
        RowBox[{"{", 
         RowBox[{"fileinS", "<>", "\"\<, SUT flatness Quantiles\>\""}], 
         "}"}]}], "]"}], ",", "\"\<XLSX\>\""}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_data.xlsx\>\""}], ",", 
     "SUTresidsXYZtrim", ",", "\"\<XLSX\>\""}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export XYZ flatness height data.\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_FLAT_CCD_data.xlsx\>\""}], ",", 
      "SUTresidsXYZtrim", ",", "\"\<XLSX\>\""}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"strimplt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"SUTdatatrim", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp1", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "->", "400"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<: SUT flatness\>\"", "<>", "\"\<\\n95%range=\>\"", 
      "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF95", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\n99%range=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"hgtrangeF99", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV99= \>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"hgtrangeF99", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", "zunit$", "<>",
       "\[IndentingNewLine]", "\"\<\\nsdev=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaF", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "3"}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"]
}, Open  ]],

Cell["End of SUT flatness section.", "Section"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input"],

Cell[CellGroupData[{

Cell["\<\
Set the SUTdata to the trimmed array and iterate. Continue from here when \
desired trim is achieved.\
\>", "Section"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SUTdata", "=", "SUTdatatrim"}], ";"}]], "Input"],

Cell["\<\
Work on REF region. Do plane fit and toss out bad points. Iterate if \
necessary.\
\>", "Section"],

Cell[CellGroupData[{

Cell["Restart here for REF iteration bad point cleanup", "Subsubsection",
 CellTags->"REFdata iterate restart"],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Length", "[", "REFdata", "]"}], "==", "0"}], ",", 
    RowBox[{
     RowBox[{
     "MessageDialog", "[", "\"\<Setting REF to const plane\>\"", "]"}], ";", 
     RowBox[{"zSUTconst", "=", 
      RowBox[{"Mean", "[", 
       RowBox[{"SUTdata", "[", 
        RowBox[{"[", 
         RowBox[{"All", ",", "3"}], "]"}], "]"}], "]"}]}], ";", 
     RowBox[{"REFdata", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", "zSUTconst"}], "}"}], 
        ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], "]"}]}]}]}], 
   "]"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"zSUTconst", "=", 
  RowBox[{"Mean", "[", 
   RowBox[{"SUTdata", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "3"}], "]"}], "]"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"rplt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"REFdata", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "->", "400"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nraw REF data\>\""}]}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{
  RowBox[{"rsplt", "=."}], ";", 
  RowBox[{"rsplt", "=", 
   RowBox[{"Show", "[", 
    RowBox[{"rplt", ",", "strimplt", ",", 
     RowBox[{"PlotLabel", "->", 
      RowBox[{"fileinS", "<>", "\"\<\\nraw data\>\""}]}]}], 
    "]"}]}]}]], "Input"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Look at REF data", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"test", "=."}], ";", 
  RowBox[{"zREFdata", "=."}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"zREFdata", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"REFdata", ",", "All", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxzR", "=", 
   RowBox[{"Max", "[", "zREFdata", "]"}]}], ";", 
  RowBox[{"minzR", "=", 
   RowBox[{"Min", "[", "zREFdata", "]"}]}], ";", 
  RowBox[{"sigmaR", "=", 
   RowBox[{"StandardDeviation", "[", "zREFdata", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"zbinR", "=", 
   RowBox[{"BinCounts", "[", 
    RowBox[{"zREFdata", ",", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"maxzR", "-", "minzR"}], ")"}], "/", "25"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"hrange", "[", 
    RowBox[{"binlist_", ",", "min_", ",", "max_"}], "]"}], ":=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"binlist", ",", 
     RowBox[{"{", 
      RowBox[{"min", ",", "max"}], "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"hgtrangeR99", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"zREFdata", ",", "0.005", ",", "0.995"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"PVrangeR99", "=", 
   RowBox[{
    RowBox[{"hgtrangeR99", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrangeR99", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{"sigmaR", "//", 
  RowBox[{
   RowBox[{"NumberForm", "[", 
    RowBox[{"#", ",", "5"}], "]"}], "&"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"histresidplt", "=", 
   RowBox[{"Histogram", "[", 
    RowBox[{"zREFdata", ",", 
     RowBox[{"ImageSize", "->", "400"}], ",", 
     RowBox[{"BaseStyle", "\[Rule]", 
      RowBox[{"Directive", "[", 
       RowBox[{"Bold", ",", 
        RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
        RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
     RowBox[{"AxesLabel", "->", 
      RowBox[{"{", 
       RowBox[{"zunit$", ",", "\"\<\>\""}], "}"}]}], ",", 
     RowBox[{"PlotLabel", "\[Rule]", 
      RowBox[{"fileinS", "<>", "\"\<\\n99% range=\>\"", "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{
         RowBox[{"hrange", "[", 
          RowBox[{"zREFdata", ",", "0.005", ",", "0.995"}], "]"}], "//", 
         RowBox[{
          RowBox[{"NumberForm", "[", 
           RowBox[{"#", ",", "5"}], "]"}], "&"}]}], "]"}], "<>", 
       "\"\< PV99=\>\"", "<>", 
       RowBox[{"ToString", "[", "PVrangeR99", "]"}], "<>", "\"\<\\nsdev=\>\"",
        "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{"sigmaR", "//", 
         RowBox[{
          RowBox[{"NumberForm", "[", 
           RowBox[{"#", ",", "5"}], "]"}], "&"}]}], "]"}], "<>", 
       "zunit$"}]}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"histresidplt", ",", 
   RowBox[{"Dynamic", "[", 
    RowBox[{"MousePosition", "[", "\"\<Graphics\>\"", "]"}], "]"}]}], 
  "}"}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[CellGroupData[{

Cell["Now fit a plane surface to the REF points", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"fitbasisR", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "x", ",", "y"}], "}"}]}], ";", 
  RowBox[{"fitidxR", "=", "\"\<1,1\>\""}], ";"}], "\n", 
 RowBox[{"fitordR$", "=", 
  RowBox[{"StringTake", "[", 
   RowBox[{
    RowBox[{"ToString", "[", "fitbasisR", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"2", ",", 
      RowBox[{"-", "2"}]}], "}"}]}], "]"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"REFfit", "[", 
   RowBox[{"x_", ",", "y_"}], "]"}], "=", 
  RowBox[{"Fit", "[", 
   RowBox[{"REFdata", ",", "fitbasisR", ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "y"}], "}"}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"vp1", "=", "vp"}]], "Input"],

Cell[BoxData[
 RowBox[{"refplt", "=", 
  RowBox[{"Plot3D", "[", 
   RowBox[{
    RowBox[{"REFfit", "[", 
     RowBox[{"x", ",", "y"}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "xminCCD", ",", "xmaxCCD"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"y", ",", "ymin", ",", "ymax"}], "}"}], ",", 
    RowBox[{"ColorFunction", "->", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "\[Rule]", "200"}], ",", 
    RowBox[{"PlotStyle", "->", 
     RowBox[{"Opacity", "[", "0.5", "]"}]}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp1", "]"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"REFcorrected", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"REFdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
       RowBox[{"REFdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"REFdata", "[", 
         RowBox[{"[", 
          RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
        RowBox[{"REFfit", "[", 
         RowBox[{
          RowBox[{"REFdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"REFdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}]}], "}"}], 
     "\[IndentingNewLine]", ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", 
       RowBox[{"Length", "[", "REFdata", "]"}]}], "}"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"reflen$", "=", 
  RowBox[{"ToString", "[", 
   RowBox[{"Length", "[", "REFcorrected", "]"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"REFresidsPlt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"REFcorrected", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{
      "\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<Z[\[Micro]m]\>\""}], 
      "}"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<\\nThis shows REF after subt plane fit\>\""}]}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_plot.tiff\>\""}], ",", 
     "REFresidsPlt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Export", "[", 
   RowBox[{
    RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_plot.tiff\>\""}], ",", 
    "REFresidsPlt", ",", 
    RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
    RowBox[{"ImageResolution", "->", "100"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"zREFresids", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"REFcorrected", ",", "All", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}]], "Input"],

Cell["Look at quality of REF plane correction to REF points:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxzR2", "=", 
   RowBox[{"Max", "[", "zREFresids", "]"}]}], ";", 
  RowBox[{"minzR2", "=", 
   RowBox[{"Min", "[", "zREFresids", "]"}]}], ";", 
  RowBox[{"sigmaR2", "=", 
   RowBox[{"StandardDeviation", "[", "zREFresids", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"zbinR2", "=", 
   RowBox[{"BinCounts", "[", 
    RowBox[{"zREFresids", ",", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"maxzR2", "-", "minzR2"}], ")"}], "/", "25"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"hrange", "[", 
    RowBox[{"binlist_", ",", "min_", ",", "max_"}], "]"}], ":=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"binlist", ",", 
     RowBox[{"{", 
      RowBox[{"min", ",", "max"}], "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"hgtrange99", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"zREFresids", ",", "0.005", ",", "0.995"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"PVrange99", "=", 
   RowBox[{
    RowBox[{"hgtrange99", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrange99", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{"sigmaR2", "//", 
  RowBox[{
   RowBox[{"NumberForm", "[", 
    RowBox[{"#", ",", "5"}], "]"}], "&"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"histREFresidplt", "=", 
   RowBox[{"Histogram", "[", 
    RowBox[{"zREFresids", ",", "20", ",", 
     RowBox[{"ImageSize", "->", "400"}], ",", 
     RowBox[{"BaseStyle", "\[Rule]", 
      RowBox[{"Directive", "[", 
       RowBox[{"Bold", ",", 
        RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
        RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
     RowBox[{"AxesLabel", "->", 
      RowBox[{"{", 
       RowBox[{"zunit$", ",", "\"\<\>\""}], "}"}]}], ",", 
     RowBox[{"PlotLabel", "\[Rule]", 
      RowBox[{
      "fileinS", "<>", "\"\< REFresids\>\"", "<>", "\"\<\\n99%=\>\"", "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{
         RowBox[{"hrange", "[", 
          RowBox[{"zREFresids", ",", "0.005", ",", "0.995"}], "]"}], "//", 
         RowBox[{
          RowBox[{"NumberForm", "[", 
           RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", 
       "\"\<, PV99=\>\"", "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{"PVrange99", "//", 
         RowBox[{
          RowBox[{"NumberForm", "[", 
           RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", 
       "\"\<\\nsdev=\>\"", "<>", 
       RowBox[{"ToString", "[", 
        RowBox[{"sigmaR2", "//", 
         RowBox[{
          RowBox[{"NumberForm", "[", 
           RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", 
       "zunit$"}]}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"histREFresidplt", ",", 
   RowBox[{"Dynamic", "[", 
    RowBox[{"MousePosition", "[", "\"\<Graphics\>\"", "]"}], "]"}]}], 
  "}"}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_histo.tiff\>\""}], ",", 
     "histREFresidplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export REF resids histogram plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_histo.tiff\>\""}], ",", 
      "histREFresidplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"rbwc", "=", 
  RowBox[{"BoxWhiskerChart", "[", 
   RowBox[{"zREFresids", ",", 
    RowBox[{"{", 
     RowBox[{"\"\<Outliers\>\"", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<MeanMarker\>\"", ",", "1.0", ",", "Thick"}], "}"}]}], 
     "}"}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"PlotLabel", "\[Rule]", 
     RowBox[{"fileinS", "<>", "\"\< REFresids\>\"", "<>", "\"\<\\n99%=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{"hrange", "[", 
         RowBox[{"zREFresids", ",", "0.005", ",", "0.995"}], "]"}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV99=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"PVrange99", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<\\nsdev=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaR2", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", "4"}], "]"}], "&"}]}], "]"}], "<>", "zunit$"}]}], 
    ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"zunit$", ",", "\"\<\>\""}], "}"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_bw.tiff\>\""}], ",", "rbwc", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export REF box whisker chart file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_REF_bw.tiff\>\""}], ",", "rbwc", 
      ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"vp1", "=", 
  RowBox[{"{", 
   RowBox[{"2", ",", "0", ",", "0"}], "}"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SUTandREFplane", "=", 
  RowBox[{"Show", "[", 
   RowBox[{"rsplt", ",", "refplt", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp1", "]"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{
     "fileinS", "<>", "\"\<\\nREF plane fit to trimmed point range\>\""}]}]}],
    "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_plotwithref.tiff\>\""}], ",", 
     "SUTandREFplane", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export SUT&REF&fitplane plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_plotwithref.tiff\>\""}], ",", 
      "SUTandREFplane", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "\[Rule]", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"]
}, Open  ]],

Cell["Iterate REF trim and fit.", "Subsubsection"],

Cell["Trim off bad points from REF region.", "Text"],

Cell[CellGroupData[{

Cell["Trim the outliers here.", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"threshR", "=", 
  RowBox[{"sigmaR2", "*", "4"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"threshR", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<Enter \[PlusMinus]threshold value for trimming bad REF points.\>\"", 
    ",", "threshR"}], "]"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell["Trim both the XYZ and the Z data lists", "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Remove", " ", "the", " ", "plane", " ", "from", " ", "the", " ", "z"}], 
    "-", 
    RowBox[{
    "data", " ", "but", " ", "not", " ", "from", " ", "the", " ", "XYZ", " ", 
     "data"}]}], "*)"}], 
  RowBox[{
   RowBox[{"REFresidsZtrim", "=", 
    RowBox[{
     RowBox[{"Drop", "[", 
      RowBox[{
       RowBox[{"Reap", "[", " ", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Abs", "[", 
              RowBox[{
               RowBox[{"REFdata", "[", 
                RowBox[{"[", 
                 RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
               RowBox[{"REFfit", "[", 
                RowBox[{
                 RowBox[{"REFdata", "[", 
                  RowBox[{"[", 
                   RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                 RowBox[{"REFdata", "[", 
                  RowBox[{"[", 
                   RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "]"}], 
             "<", "threshR"}], ",", 
            RowBox[{"Sow", "[", 
             RowBox[{
              RowBox[{"REFdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"REFfit", "[", 
               RowBox[{
                RowBox[{"REFdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"REFdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "]"}]}], 
           "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", 
            RowBox[{"Length", "[", "REFdata", "]"}]}], "}"}]}], "]"}], "]"}], 
       ",", "1"}], "]"}], "//", 
     RowBox[{
      RowBox[{"Flatten", "[", 
       RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}]}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"REFdatatrim", "=", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{
      RowBox[{"Reap", "[", " ", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              RowBox[{"REFdata", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
              RowBox[{"REFfit", "[", 
               RowBox[{
                RowBox[{"REFdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
                RowBox[{"REFdata", "[", 
                 RowBox[{"[", 
                  RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}]}], "]"}], 
            "<", "threshR"}], ",", 
           RowBox[{"Sow", "[", 
            RowBox[{"REFdata", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"Length", "[", "REFdata", "]"}]}], "}"}]}], "]"}], "]"}], 
      ",", "1"}], "]"}], "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],

Cell[BoxData[
 RowBox[{
  RowBox[{"REFresidsXYZtrim", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"REFdatatrim", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
       RowBox[{"REFdatatrim", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
       RowBox[{"REFresidsZtrim", "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "REFdatatrim", "]"}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{"refflag", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"refflag", "=", 
  RowBox[{"Input", "[", 
   RowBox[{
   "\"\<If need to iterate REF fit, set refflag to 1\>\"", ",", "refflag"}], 
   "]"}]}], "\n", 
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"refflag", "==", "1"}], ",", 
   RowBox[{
    RowBox[{"REFdata", "=", "REFdatatrim"}], ";", 
    RowBox[{"NotebookLocate", "[", "\"\<REFdata iterate restart\>\"", "]"}], 
    ";", 
    RowBox[{"Abort", "[", "]"}]}], ",", 
   RowBox[{"MessageDialog", "[", "\"\<Finished with REF trim\>\"", "]"}]}], 
  "]"}]}], "Input"],

Cell[CellGroupData[{

Cell["\<\
Now do the subtraction of the REF plane from the CCD points. Need to set \
upstemcal correction factor before execution here.\
\>", "Section"],

Cell[BoxData["upstemcal"], "Input"],

Cell[BoxData[
 RowBox[{"MessageDialog", "[", 
  RowBox[{"\"\<Subtracting upstemcal value: \>\"", "<>", 
   RowBox[{"ToString", "[", "upstemcal", "]"}]}], "]"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SUTcorrected", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"SUTdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
       RowBox[{"SUTdata", "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "2"}], "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"SUTdata", "[", 
         RowBox[{"[", 
          RowBox[{"i", ",", "3"}], "]"}], "]"}], "-", 
        RowBox[{"REFfit", "[", 
         RowBox[{
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"SUTdata", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "2"}], "]"}], "]"}]}], "]"}], "-", 
        "upstemcal"}]}], "}"}], "\[IndentingNewLine]", ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", 
       RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\n", 
 RowBox[{"Length", "[", "SUTdata", "]"}]}], "Input"],

Cell[BoxData[
 RowBox[{"CCDabshgt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"SUTcorrected", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{
      "\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<Z[\[Micro]m]\>\""}], 
      "}"}]}], ",", 
    RowBox[{"PlotLabel", "->", "fileinS"}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"zeroplane", "=", 
   RowBox[{"Plot3D", "[", 
    RowBox[{"0", ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", "xmin", ",", "xmax"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"y", ",", "ymin", ",", "ymax"}], "}"}], ",", 
     RowBox[{"PlotStyle", "->", 
      RowBox[{"Opacity", "[", "0.5", "]"}]}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"vp2", "=", 
   RowBox[{"{", 
    RowBox[{"2", ",", "0", ",", ".5"}], "}"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"SUTcor3D", "=", 
  RowBox[{"Show", "[", 
   RowBox[{"CCDabshgt", ",", "zeroplane", ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp2", "]"}]}], ",", 
    RowBox[{"ImageSize", "->", "400"}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "After", ",", "GeneratedCell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_plotwithdatum.tiff\>\""}], ",", 
     "SUTcor3D", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Export", "[", 
   RowBox[{
    RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_plotwithdatum.tiff\>\""}], ",", 
    "SUTcor3D", ",", 
    RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
    RowBox[{"ImageResolution", "->", "100"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"zSUTresids", "=", 
   RowBox[{
    RowBox[{"Take", "[", 
     RowBox[{"SUTcorrected", ",", "All", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}], "//", "Flatten"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"quantlist", "=", 
   RowBox[{"Reverse", "[", 
    RowBox[{"{", 
     RowBox[{
     "0.0", ",", "0.005", ",", "0.01", ",", "0.025", ",", "0.25", ",", "0.50",
       ",", "0.75", ",", "0.975", ",", "0.99", ",", "0.995", ",", "1.0"}], 
     "}"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qres", "=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"zSUTresids", ",", "quantlist"}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"qtableABSZ", "=", 
   RowBox[{"Transpose", "[", 
    RowBox[{"{", 
     RowBox[{"quantlist", ",", "qres"}], "}"}], "]"}]}], ";", 
  RowBox[{"qtableABSZ", "//", "TableForm"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{"q99range", "=", 
  RowBox[{
   RowBox[{"qres", "[", 
    RowBox[{"[", "8", "]"}], "]"}], "-", 
   RowBox[{"qres", "[", 
    RowBox[{"[", "2", "]"}], "]"}]}]}]], "Input"],

Cell[BoxData[
 RowBox[{"surfdenplt", "=", 
  RowBox[{"ListDensityPlot", "[", 
   RowBox[{"SUTcorrected", ",", 
    RowBox[{"PlotRange", "\[Rule]", "All"}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"Mesh", "->", "9"}], ",", 
    RowBox[{"PlotLegends", "\[Rule]", 
     RowBox[{"BarLegend", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<Rainbow\>\"", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"qres", "[", 
            RowBox[{"[", 
             RowBox[{"-", "1"}], "]"}], "]"}], ",", 
           RowBox[{"qres", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], "}"}], ",", 
       RowBox[{"LabelStyle", "\[Rule]", 
        RowBox[{"Directive", "[", 
         RowBox[{"Bold", ",", 
          RowBox[{"FontFamily", "\[Rule]", "\"\<Helvetica\>\""}]}], "]"}]}]}],
       "]"}]}], ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nSUT - REF\>\""}]}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_surfdensityplt.tiff\>\""}], ",", 
     "surfdenplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export Surface density plot\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_surfdensityplt.tiff\>\""}], ",",
       "surfdenplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "\[Rule]", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellChangeTimes->{{3.64884709193489*^9, 3.648847106948991*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"hrange", "[", 
    RowBox[{"binlist_", ",", "min_", ",", "max_"}], "]"}], ":=", 
   RowBox[{"Quantile", "[", 
    RowBox[{"binlist", ",", 
     RowBox[{"{", 
      RowBox[{"min", ",", "max"}], "}"}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"hgtrangeS95", "=."}], ";", 
  RowBox[{"hgtrangeS99", "=."}], ";", 
  RowBox[{"PVrangeS95", "=."}], ";", 
  RowBox[{"PVrangeS99", "=."}], " ", ";"}]], "Input"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxzS", "=", 
   RowBox[{"Max", "[", "zSUTresids", "]"}]}], ";", 
  RowBox[{"minzS", "=", 
   RowBox[{"Min", "[", "zSUTresids", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"meanZcor", "=", 
   RowBox[{
    RowBox[{"Mean", "[", "zSUTresids", "]"}], "//", "Chop"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"sigmaS", "=", 
   RowBox[{"StandardDeviation", "[", "zSUTresids", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"zbinS", "=", 
   RowBox[{"BinCounts", "[", 
    RowBox[{"zSUTresids", ",", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"maxzS", "-", "minzS"}], ")"}], "/", "25"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"hgtrangeS95", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"zSUTresids", ",", "0.025", ",", "0.975"}], "]"}]}], ";", 
  RowBox[{"PVrangeS95", "=", 
   RowBox[{
    RowBox[{"hgtrangeS95", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrangeS95", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";", 
  RowBox[{"hgtrangeS99", "=", 
   RowBox[{"hrange", "[", 
    RowBox[{"zSUTresids", ",", "0.005", ",", "0.995"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"PVrangeS99", "=", 
   RowBox[{
    RowBox[{"hgtrangeS99", "[", 
     RowBox[{"[", "2", "]"}], "]"}], "-", 
    RowBox[{"hgtrangeS99", "[", 
     RowBox[{"[", "1", "]"}], "]"}]}]}], ";"}], "\n", 
 RowBox[{"sigmaS", "//", 
  RowBox[{
   RowBox[{"NumberForm", "[", 
    RowBox[{"#", ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}]}], "Input"],

Cell[BoxData[
 RowBox[{"Median", "[", "zSUTresids", "]"}]], "Input"]
}, Open  ]],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"histSUTresidplt", "=", 
  RowBox[{"Histogram", "[", 
   RowBox[{"zSUTresids", ",", "20", ",", 
    RowBox[{"ImageSize", "->", "400"}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"zunit$", ",", "\"\<\>\""}], "}"}]}], ",", 
    RowBox[{"PlotLabel", "\[Rule]", 
     RowBox[{"fileinS", "<>", "\"\<: SUT w/REFsubt\\n95%=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{"hrange", "[", 
         RowBox[{"zSUTresids", ",", "0.025", ",", "0.975"}], "]"}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"PVrangeS95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$", "<>", "\"\<\\nmean=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"meanZcor", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, sigma=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaS", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ToString", "[", "fileinS", "]"}], "<>", 
      "\"\<_ABSZ_histowithdatum.tiff\>\""}], ",", "histSUTresidplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export SUT-REF histogram\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"ToString", "[", "fileinS", "]"}], "<>", 
       "\"\<_ABSZ_histowithdatum.tiff\>\""}], ",", "histSUTresidplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}], ",", 
    RowBox[{"Method", "\[Rule]", "\"\<Queued\>\""}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"ChartElementData", "[", "\"\<DistributionChart\>\"", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"sdensityplt", "=", 
  RowBox[{"DistributionChart", "[", 
   RowBox[{"zSUTresids", ",", 
    RowBox[{"ChartElementFunction", "\[Rule]", 
     RowBox[{"ChartElementData", "[", "\"\<SmoothDensity\>\"", "]"}]}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"FrameLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<\>\"", ",", "zunit$"}], "}"}]}], ",", 
    RowBox[{"PlotLabel", "\[Rule]", 
     RowBox[{"fileinS", "<>", "\"\<: SUT w/REFsubt\\n95%=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{"hrange", "[", 
         RowBox[{"zSUTresids", ",", "0.025", ",", "0.975"}], "]"}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"PVrangeS95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$", "<>", "\"\<\\nmean=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"meanZcor", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, sigma=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaS", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"zunit$", ",", "zunit$"}], "}"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"quantileMean", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"xmin_", ",", "xmax_"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"ymin_", ",", "ymax_"}], "}"}]}], "}"}], ",", "data_", ",", 
    "metadata_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "min", ",", "max", ",", "lq", ",", " ", "uq", ",", " ", "median"}], 
     "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "min", ",", "lq", ",", " ", "median", ",", " ", "uq", ",", " ", 
        "max"}], "}"}], "=", 
      RowBox[{"Quantile", "[", 
       RowBox[{"data", ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0.1", ",", "0.5", ",", "0.9", ",", "1"}], "}"}]}],
        "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"Line", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"xmin", ",", " ", "median"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"xmax", ",", " ", "median"}], "}"}]}], "}"}], "]"}], 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_SABSZ_CCD_density.tiff\>\""}], ",", 
     "sdensityplt", ",", 
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export smooth density chart file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_density.tiff\>\""}], ",", 
      "sdensityplt", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input",
 CellChangeTimes->{3.648846970207542*^9, 3.648847009593994*^9}],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"bwc", "=", 
  RowBox[{"BoxWhiskerChart", "[", 
   RowBox[{"zSUTresids", ",", 
    RowBox[{"{", 
     RowBox[{"\"\<Outliers\>\"", ",", 
      RowBox[{"{", 
       RowBox[{"\"\<MeanMarker\>\"", ",", "1.0", ",", "Thick"}], "}"}]}], 
     "}"}], ",", 
    RowBox[{"BaseStyle", "\[Rule]", 
     RowBox[{"Directive", "[", 
      RowBox[{"Bold", ",", 
       RowBox[{"FontFamily", "\[Rule]", "\"\<Arial\>\""}], ",", 
       RowBox[{"FontSize", "->", "12"}]}], "]"}]}], ",", 
    RowBox[{"FrameLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<\>\"", ",", "zunit$"}], "}"}]}], ",", 
    RowBox[{"PlotLabel", "\[Rule]", 
     RowBox[{"fileinS", "<>", "\"\<: SUT w/REFsubt\\n95%=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{
        RowBox[{"hrange", "[", 
         RowBox[{"zSUTresids", ",", "0.025", ",", "0.975"}], "]"}], "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, PV95=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"PVrangeS95", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$", "<>", "\"\<\\nmean=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"meanZcor", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "\"\<, sigma=\>\"", "<>", 
      RowBox[{"ToString", "[", 
       RowBox[{"sigmaS", "//", 
        RowBox[{
         RowBox[{"NumberForm", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}]}], "]"}], "&"}]}], "]"}], "<>", 
      "zunit$"}]}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"zunit$", ",", "zunit$"}], "}"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_bw.tiff\>\""}], ",", "bwc", ",", 
     
     RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
     RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export box whisker chart file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_bw.tiff\>\""}], ",", "bwc", ",", 
      RowBox[{"\"\<ImageEncoding\>\"", "->", "\"\<LZW\>\""}], ",", 
      RowBox[{"ImageResolution", "->", "100"}]}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_quantile.xlsx\>\""}], ",", 
     RowBox[{"Prepend", "[", 
      RowBox[{"qtableABSZ", ",", 
       RowBox[{"{", 
        RowBox[{"fileinS", "<>", "\"\<, Quantiles\>\""}], "}"}]}], "]"}], 
     ",", "\"\<XLSX\>\""}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export Quantile table file\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_quantile.xlsx\>\""}], ",", 
      RowBox[{"Prepend", "[", 
       RowBox[{"qtableABSZ", ",", 
        RowBox[{"{", 
         RowBox[{"fileinS", "<>", "\"\<, Quantiles\>\""}], "}"}]}], "]"}], 
      ",", "\"\<XLSX\>\""}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"],

Cell["Output the detrended data triplets", "Text"],

Cell["\<\
ADD HEADER info to output file. Output in Excel format. This format drops off \
the brackets upon opening in Excel. Ordinary text file imports with brackets \
showing.
Can\[CloseCurlyQuote]t make the header info appear on separate lines at start \
of Excel file.\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SUTout", "=", 
   RowBox[{"Prepend", "[", 
    RowBox[{"SUTcorrected", ",", 
     RowBox[{"{", 
      RowBox[{"fileinS", ",", 
       RowBox[{"DateString", "[", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "\"\<X(mm)\>\"", ",", "\"\<Y(mm)\>\"", ",", "\"\<Z(micron)\>\""}], 
        "}"}]}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SUTout", "[", 
   RowBox[{"[", 
    RowBox[{"1", ";;", "5"}], "]"}], "]"}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{"SelectionMove", "[", 
  RowBox[{"nb", ",", "Next", ",", "Cell"}], "]"}]], "Input",
 CellAutoOverwrite->False],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_data.xlsx\>\""}], ",", "SUTout", 
     ",", "\"\<XLSX\>\""}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{
   "\"\<Export absolute height data relative to gauge block datum.\>\"", ",", 
    
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_ABSZ_CCD_data.xlsx\>\""}], ",", "SUTout",
       ",", "\"\<XLSX\>\""}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[BoxData[
 RowBox[{"statreport", "=", 
  RowBox[{
   RowBox[{
   "StringTemplate", "[", 
    "\"\<Summary statistics for e2v sensor data file:\\n\\t \
`1`.\\n\\nFlatness (CCD-031)\\n\\tPV95% =`2`\\t[<10\[Micro]m]\\n\\nAbsolute \
Height relative to 13.000mm datum (CCD-030)\\n\\tMean Z   =\\t`3`\\t[-25\
\[Micro]m to +25\[Micro]m]\\n\\tMedian Z =\\t`4`\\n\\tPV95%    =\\t`5`\\t[<18\
\[Micro]m]\\n\\nQuantiles\\n`6`\\n\\nReport generated `7`\\nNotebook version: \
`8`\\nLast modified: `9`\>\"", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    "]"}], "[", 
   RowBox[{"fileinS", ",", "PVrangeF95", ",", "meanZcor", ",", 
    RowBox[{"Median", "[", "zSUTresids", "]"}], ",", "PVrangeS95", ",", 
    RowBox[{"qtableABSZ", "//", "TableForm"}], ",", 
    RowBox[{"DateString", "[", "]"}], ",", 
    RowBox[{"CurrentValue", "[", "\"\<NotebookFileName\>\"", "]"}], ",", 
    RowBox[{
     RowBox[{"\"\<FileModificationTime\>\"", "/.", 
      RowBox[{"NotebookInformation", "[", "]"}]}], "//", "DateString"}]}], 
   "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{"autoOutput", ",", 
   RowBox[{"Export", "[", 
    RowBox[{
     RowBox[{"fileinS", "<>", "\"\<_CCD_stat_report.txt\>\""}], ",", 
     "statreport", ",", "\"\<TEXT\>\""}], "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 StyleBox[
  RowBox[{"Button", "[", 
   RowBox[{"\"\<Export statistics TXT file.\>\"", ",", 
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"fileinS", "<>", "\"\<_CCD_stat_report.txt\>\""}], ",", 
      "statreport", ",", "\"\<TEXT\>\""}], "]"}]}], "]"}],
  FontColor->RGBColor[1, 0, 1]]], "Input"]
}, Open  ]]
}, Open  ]],

Cell["END of main analysis program.", "Section"],

Cell["Junk", "Title"],

Cell[CellGroupData[{

Cell["\<\
Remove obvious outliers from SUTdata if necessary. Skip this section if not \
necessary.\
\>", "Section"],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"minS", ",", "medianS", ",", "maxS", ",", "stddevS"}], "}"}], "=", 
  
  RowBox[{"Operate", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Min", "[", "#", "]"}], ",", 
       RowBox[{"Median", "[", "#", "]"}], ",", 
       RowBox[{"Max", "[", "#", "]"}], ",", 
       RowBox[{"StandardDeviation", "[", "#", "]"}]}], "}"}], "&"}], ",", 
    RowBox[{
     RowBox[{"SUTdata", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", 
        RowBox[{"{", "3", "}"}]}], "]"}], "]"}], "//", "Flatten"}], ",", 
    "0"}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{"MedianDeviation", "[", 
  RowBox[{
   RowBox[{"SUTdata", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", 
      RowBox[{"{", "3", "}"}]}], "]"}], "]"}], "//", "Flatten"}], 
  "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"threshS", "=", 
  RowBox[{"3", "*", 
   RowBox[{"(", 
    RowBox[{"Min", "[", 
     RowBox[{
      RowBox[{"maxS", "-", "medianS"}], ",", 
      RowBox[{"medianS", "-", "minS"}]}], "]"}], ")"}], 
   RowBox[{"(*", 
    RowBox[{
    "Set", " ", "trim", " ", "threshold", " ", "to", " ", "3", " ", "times", 
     " ", "the", " ", "smaller", " ", "deviation", " ", "from", " ", "the", 
     " ", "median"}], "*)"}]}]}]], "Input"],

Cell[BoxData[
 RowBox[{"threshS", "=", 
  RowBox[{"2", "*", "stddevS", 
   RowBox[{"(*", 
    RowBox[{
    "Set", " ", "trim", " ", "threshold", " ", "to", " ", "3", " ", "times", 
     " ", "the", " ", "smaller", " ", "deviation", " ", "from", " ", "the", 
     " ", "median"}], "*)"}]}]}]], "Input"],

Cell[BoxData[
 RowBox[{"Length", "[", "SUTdata", "]"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"testS", "=."}], ";"}], "\n", 
 RowBox[{
  RowBox[{"testS", " ", "=", 
   RowBox[{"Reap", "[", " ", 
    RowBox[{"Do", "[", 
     RowBox[{
      RowBox[{"If", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"SUTdata", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "[", 
            RowBox[{"[", "3", "]"}], "]"}], "-", "medianS"}], "]"}], "<", 
         "threshS"}], "\[IndentingNewLine]", ",", 
        RowBox[{"Sow", "[", 
         RowBox[{"SUTdata", "[", 
          RowBox[{"[", "i", "]"}], "]"}], "]"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", "SUTdata", "]"}]}], "}"}]}], "]"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"testS", "=", 
   RowBox[{
    RowBox[{"Drop", "[", 
     RowBox[{"testS", ",", "1"}], "]"}], "//", 
    RowBox[{
     RowBox[{"Flatten", "[", 
      RowBox[{"#", ",", "2"}], "]"}], "&"}]}]}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{"Length", "[", "testS", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{
    RowBox[{"Length", "[", "testS", "]"}], "==", 
    RowBox[{"Length", "[", "SUTdata", "]"}]}], ",", 
   RowBox[{
   "MessageDialog", "[", "\"\<No points were trimmed from SUTdata\>\"", 
    "]"}]}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "[", "testS", "]"}], ">", "0"}], ",", 
     RowBox[{"SUTdata", "=", "testS"}], ",", 
     RowBox[{
     "MessageDialog", "[", "\"\<Problem with trimming SUTdata\>\"", "]"}]}], 
    "]"}], ";"}], 
  RowBox[{"(*", 
   RowBox[{
   "Abort", " ", "if", " ", "problem", " ", "trimming", " ", "SUT", " ", 
    "data"}], "*)"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"testS", "=."}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{"splt", "=", 
  RowBox[{"ListPointPlot3D", "[", 
   RowBox[{"SUTdata", ",", 
    RowBox[{"PlotRange", "->", "All"}], ",", 
    RowBox[{"ViewPoint", "->", 
     RowBox[{"Dynamic", "[", "vp", "]"}]}], ",", 
    RowBox[{"ColorFunction", "\[Rule]", "\"\<Rainbow\>\""}], ",", 
    RowBox[{"ImageSize", "->", "400"}], ",", 
    RowBox[{"AxesLabel", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Xval\>\"", ",", "\"\<Yval\>\"", ",", "\"\<\>\""}], "}"}]}],
     ",", 
    RowBox[{"PlotLabel", "->", 
     RowBox[{"fileinS", "<>", "\"\<\\nSUT-outliers\>\""}]}]}], 
   "]"}]}]], "Input"]
}, Closed]]
},
CellGrouping->Manual,
WindowSize->{765, 710},
WindowMargins->{{78, Automatic}, {Automatic, 0}},
ShowCellTags->True,
FrontEndVersion->"10.1 for Mac OS X x86 (32-bit, 64-bit Kernel) (March 23, \
2015)",
StyleDefinitions->"MyStyle01.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{
 "data ready"->{
  Cell[40347, 1267, 63, 1, 45, "Subsubsection",
   CellTags->"data ready"]},
 "pick MST file num"->{
  Cell[27821, 840, 88, 1, 51, "Subsubsection",
   CellTags->"pick MST file num"]},
 "REFdata iterate restart"->{
  Cell[84931, 2638, 111, 1, 45, "Subsubsection",
   CellTags->"REFdata iterate restart"]},
 "XY range restriction start"->{
  Cell[42814, 1358, 184, 4, 51, "Subsubsection",
   CellTags->"XY range restriction start"]}
 }
*)
(*CellTagsIndex
CellTagsIndex->{
 {"data ready", 134947, 4173},
 {"pick MST file num", 135048, 4176},
 {"REFdata iterate restart", 135161, 4179},
 {"XY range restriction start", 135285, 4182}
 }
*)
(*NotebookFileOutline
Notebook[{
Cell[557, 20, 55, 0, 77, "Title"],
Cell[615, 22, 32, 0, 27, "Subsubtitle"],
Cell[650, 24, 47, 0, 63, "Subtitle"],
Cell[700, 26, 46, 0, 63, "Subtitle"],
Cell[749, 28, 674, 12, 189, "Subsubtitle"],
Cell[CellGroupData[{
Cell[1448, 44, 182, 3, 118, "Section"],
Cell[CellGroupData[{
Cell[1655, 51, 117, 3, 72, "Section",
 InitializationGroup->True],
Cell[1775, 56, 108, 3, 42, "Text"],
Cell[1886, 61, 83, 2, 25, "Input"],
Cell[1972, 65, 58, 1, 26, "Input"],
Cell[2033, 68, 316, 6, 42, "Text"],
Cell[2352, 76, 298, 7, 74, "Input"],
Cell[2653, 85, 145, 4, 26, "Input",
 InitializationGroup->True],
Cell[2801, 91, 685, 14, 26, "Input",
 InitializationCell->True,
 InitializationGroup->True],
Cell[3489, 107, 426, 12, 58, "Input",
 InitializationGroup->True],
Cell[3918, 121, 94, 2, 26, "Input",
 InitializationGroup->True],
Cell[4015, 125, 131, 2, 26, "Input",
 InitializationGroup->True],
Cell[4149, 129, 136, 2, 26, "Input",
 InitializationGroup->True],
Cell[CellGroupData[{
Cell[4310, 135, 125, 3, 40, "Subsubsection",
 InitializationGroup->True],
Cell[4438, 140, 743, 25, 103, "Input",
 InitializationGroup->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[5230, 171, 346, 6, 72, "Section",
 InitializationGroup->True],
Cell[5579, 179, 250, 7, 26, "Input"],
Cell[5832, 188, 242, 5, 42, "Text",
 InitializationGroup->True],
Cell[6077, 195, 317, 7, 42, "Text",
 InitializationGroup->True],
Cell[6397, 204, 293, 6, 42, "Text",
 InitializationGroup->True],
Cell[6693, 212, 199, 4, 25, "Input",
 InitializationGroup->True],
Cell[6895, 218, 476, 10, 26, "Input",
 InitializationGroup->True],
Cell[7374, 230, 682, 16, 26, "Input",
 InitializationGroup->True],
Cell[8059, 248, 405, 11, 26, "Input",
 InitializationGroup->True],
Cell[8467, 261, 217, 5, 42, "Text",
 InitializationGroup->True],
Cell[8687, 268, 219, 5, 25, "Input",
 InitializationGroup->True],
Cell[8909, 275, 643, 16, 63, "Input",
 InitializationGroup->True],
Cell[9555, 293, 253, 5, 42, "Text",
 InitializationGroup->True],
Cell[9811, 300, 718, 18, 63, "Input",
 InitializationGroup->True],
Cell[10532, 320, 1603, 42, 204, "Input",
 InitializationGroup->True],
Cell[CellGroupData[{
Cell[12160, 366, 413, 8, 53, "Subsubsection",
 InitializationGroup->True],
Cell[12576, 376, 2791, 68, 170, "Input",
 InitializationGroup->True],
Cell[15370, 446, 193, 4, 26, "Input",
 InitializationGroup->True],
Cell[15566, 452, 415, 10, 25, "Input",
 InitializationGroup->True],
Cell[15984, 464, 281, 6, 26, "Input",
 InitializationGroup->True],
Cell[16268, 472, 174, 3, 25, "Input",
 InitializationGroup->True],
Cell[16445, 477, 211, 4, 26, "Input",
 InitializationGroup->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[16693, 486, 677, 12, 79, "Subsubsection",
 InitializationGroup->True],
Cell[17373, 500, 1048, 27, 69, "Input",
 InitializationGroup->True],
Cell[18424, 529, 676, 18, 51, "Input",
 InitializationGroup->True],
Cell[19103, 549, 308, 7, 57, "Text",
 InitializationGroup->True],
Cell[19414, 558, 724, 22, 83, "Input",
 InitializationGroup->True],
Cell[20141, 582, 275, 7, 36, "Input",
 InitializationGroup->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[20453, 594, 249, 5, 40, "Subsubsection",
 InitializationGroup->True],
Cell[20705, 601, 967, 24, 136, "Input",
 InitializationGroup->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[21709, 630, 376, 8, 66, "Subsubsection",
 InitializationGroup->True],
Cell[22088, 640, 428, 9, 26, "Input",
 InitializationGroup->True],
Cell[22519, 651, 335, 8, 26, "Input",
 InitializationGroup->True],
Cell[22857, 661, 523, 16, 26, "Input",
 InitializationGroup->True],
Cell[23383, 679, 37, 0, 42, "Text"],
Cell[23423, 681, 256, 7, 26, "Input"],
Cell[23682, 690, 141, 4, 25, "Input"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[23872, 700, 181, 3, 88, "Section"],
Cell[CellGroupData[{
Cell[24078, 707, 78, 0, 40, "Subsubsection"],
Cell[24159, 709, 82, 2, 26, "Input"],
Cell[24244, 713, 219, 5, 74, "Input"],
Cell[24466, 720, 116, 2, 26, "Input"],
Cell[24585, 724, 111, 3, 42, "Text"],
Cell[24699, 729, 133, 3, 26, "Input"],
Cell[24835, 734, 237, 6, 26, "Input"],
Cell[25075, 742, 200, 6, 26, "Input"],
Cell[25278, 750, 344, 9, 42, "Input"]
}, Open  ]],
Cell[25637, 762, 133, 3, 67, "Subsection"],
Cell[25773, 767, 77, 2, 23, "Input"],
Cell[25853, 771, 184, 5, 26, "Input"],
Cell[CellGroupData[{
Cell[26062, 780, 128, 3, 67, "Subsection"],
Cell[26193, 785, 313, 5, 72, "Text"],
Cell[26509, 792, 116, 2, 26, "Input"],
Cell[26628, 796, 416, 12, 135, "Input"],
Cell[27047, 810, 463, 15, 42, "Input"],
Cell[27513, 827, 283, 9, 26, "Input"],
Cell[CellGroupData[{
Cell[27821, 840, 88, 1, 51, "Subsubsection",
 CellTags->"pick MST file num"],
Cell[27912, 843, 63, 1, 25, "Input"],
Cell[27978, 846, 133, 3, 26, "Input"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[28172, 856, 331, 9, 106, "Input"],
Cell[28506, 867, 304, 9, 58, "Input"],
Cell[28813, 878, 306, 8, 58, "Input"],
Cell[29122, 888, 71, 0, 42, "Text"],
Cell[29196, 890, 195, 5, 26, "Input"],
Cell[29394, 897, 106, 2, 26, "Input"],
Cell[29503, 901, 382, 9, 58, "Input"],
Cell[CellGroupData[{
Cell[29910, 914, 50, 0, 42, "Text"],
Cell[29963, 916, 298, 8, 42, "Input"],
Cell[30264, 926, 406, 11, 42, "Input"],
Cell[30673, 939, 71, 1, 26, "Input"],
Cell[30747, 942, 106, 2, 26, "Input"]
}, Open  ]],
Cell[30868, 947, 110, 3, 42, "Text"],
Cell[30981, 952, 342, 9, 42, "Input"],
Cell[CellGroupData[{
Cell[31348, 965, 52, 0, 42, "Text"],
Cell[31403, 967, 350, 12, 26, "Input"],
Cell[31756, 981, 201, 4, 42, "Input"],
Cell[31960, 987, 612, 18, 74, "Input"],
Cell[32575, 1007, 167, 6, 26, "Input"],
Cell[32745, 1015, 106, 2, 26, "Input"],
Cell[32854, 1019, 128, 3, 26, "Input"],
Cell[32985, 1024, 326, 9, 26, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[33348, 1038, 105, 1, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[33456, 1041, 117, 2, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[33576, 1045, 121, 2, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[33700, 1049, 161, 4, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[33864, 1055, 201, 6, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[34068, 1063, 117, 2, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[34188, 1067, 201, 4, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[34392, 1073, 1016, 30, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[35411, 1105, 191, 5, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[35605, 1112, 158, 4, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[35766, 1118, 232, 6, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[36001, 1126, 265, 8, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[36269, 1136, 430, 12, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[36702, 1150, 295, 7, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[37000, 1159, 294, 8, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[37297, 1169, 310, 6, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[37610, 1177, 501, 16, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[38114, 1195, 150, 3, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[38267, 1200, 449, 9, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[38719, 1211, 122, 3, 25, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[38844, 1216, 1088, 32, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[39935, 1250, 118, 2, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[40056, 1254, 132, 3, 25, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[40203, 1260, 119, 3, 40, "Subsubsection"],
Cell[CellGroupData[{
Cell[40347, 1267, 63, 1, 45, "Subsubsection",
 CellTags->"data ready"],
Cell[40413, 1270, 274, 8, 26, "Input"],
Cell[40690, 1280, 42, 0, 42, "Text"],
Cell[40735, 1282, 505, 16, 58, "Input"],
Cell[41243, 1300, 309, 8, 26, "Input"],
Cell[41555, 1310, 133, 3, 26, "Input"],
Cell[41691, 1315, 353, 10, 57, "Input"],
Cell[42047, 1327, 100, 3, 26, "Input"],
Cell[42150, 1332, 140, 3, 42, "Input"]
}, Open  ]],
Cell[42305, 1338, 38, 0, 42, "Text"],
Cell[42346, 1340, 374, 12, 26, "Input"],
Cell[CellGroupData[{
Cell[42745, 1356, 66, 0, 51, "Subsection"],
Cell[42814, 1358, 184, 4, 51, "Subsubsection",
 CellTags->"XY range restriction start"],
Cell[43001, 1364, 187, 4, 54, "Text"],
Cell[43191, 1370, 591, 18, 58, "Input"],
Cell[43785, 1390, 801, 26, 74, "Input"],
Cell[44589, 1418, 267, 8, 26, "Input"],
Cell[44859, 1428, 117, 2, 26, "Input"],
Cell[44979, 1432, 99, 2, 42, "Text"],
Cell[45081, 1436, 380, 10, 42, "Input"],
Cell[45464, 1448, 70, 1, 26, "Input"],
Cell[45537, 1451, 106, 2, 26, "Input"],
Cell[45646, 1455, 626, 14, 58, "Input"],
Cell[46275, 1471, 334, 8, 42, "Input"],
Cell[46612, 1481, 475, 11, 58, "Input"],
Cell[CellGroupData[{
Cell[47112, 1496, 46, 0, 40, "Subsubsection"],
Cell[47161, 1498, 236, 8, 26, "Input"],
Cell[47400, 1508, 147, 3, 42, "Text"],
Cell[47550, 1513, 234, 8, 26, "Input"],
Cell[47787, 1523, 1802, 51, 122, "Input"],
Cell[49592, 1576, 64, 0, 42, "Text"],
Cell[49659, 1578, 676, 17, 58, "Input"]
}, Open  ]],
Cell[50350, 1598, 144, 3, 42, "Text"],
Cell[50497, 1603, 133, 3, 26, "Input"],
Cell[50633, 1608, 388, 10, 74, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[51058, 1623, 153, 3, 40, "Subsubsection"],
Cell[51214, 1628, 210, 7, 26, "Input"],
Cell[51427, 1637, 231, 8, 26, "Input"],
Cell[51661, 1647, 230, 8, 26, "Input"],
Cell[51894, 1657, 234, 8, 26, "Input"],
Cell[52131, 1667, 133, 3, 26, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[52301, 1675, 78, 0, 51, "Subsection"],
Cell[52382, 1677, 170, 5, 25, "Input"],
Cell[52555, 1684, 2167, 61, 234, "Input"],
Cell[54725, 1747, 606, 15, 58, "Input"],
Cell[55334, 1764, 606, 15, 58, "Input"]
}, Open  ]],
Cell[55955, 1782, 120, 3, 95, "Section"],
Cell[CellGroupData[{
Cell[56100, 1789, 99, 2, 34, "Subsubsection"],
Cell[56202, 1793, 400, 12, 42, "Input"],
Cell[56605, 1807, 236, 7, 26, "Input"],
Cell[56844, 1816, 129, 4, 26, "Input"],
Cell[56976, 1822, 636, 16, 58, "Input"],
Cell[57615, 1840, 385, 10, 42, "Input"],
Cell[58003, 1852, 62, 1, 26, "Input"],
Cell[CellGroupData[{
Cell[58090, 1857, 225, 5, 57, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[58318, 1864, 1010, 30, 74, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[59331, 1896, 414, 14, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[59748, 1912, 273, 6, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[60024, 1920, 297, 8, 26, "Input"],
Cell[60324, 1930, 106, 2, 26, "Input"],
Cell[60433, 1934, 313, 7, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[CellGroupData[{
Cell[60771, 1945, 92, 1, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[60866, 1948, 106, 2, 26, "Input"],
Cell[60975, 1952, 253, 7, 26, "Input"],
Cell[61231, 1961, 303, 8, 58, "Input"],
Cell[61537, 1971, 107, 1, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[61647, 1974, 2446, 61, 218, "Input"],
Cell[64096, 2037, 169, 4, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[64268, 2043, 2046, 52, 202, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[66317, 2097, 639, 19, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[66971, 2119, 198, 4, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[67172, 2125, 1705, 51, 170, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[68880, 2178, 109, 3, 26, "Input"],
Cell[68992, 2183, 2467, 63, 154, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[71462, 2248, 340, 8, 42, "Input"],
Cell[71805, 2258, 478, 11, 58, "Input"],
Cell[72286, 2271, 62, 1, 26, "Input"],
Cell[72351, 2274, 139, 3, 26, "Input"],
Cell[72493, 2279, 340, 8, 42, "Input"],
Cell[72836, 2289, 471, 11, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[73310, 2302, 1997, 52, 138, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[75310, 2356, 342, 8, 42, "Input"],
Cell[75655, 2366, 537, 12, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[76195, 2380, 159, 3, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[76357, 2385, 2327, 61, 138, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[78687, 2448, 186, 4, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[78876, 2454, 333, 8, 42, "Input"],
Cell[79212, 2464, 474, 11, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[79689, 2477, 358, 9, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[80050, 2488, 206, 5, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[80259, 2495, 290, 8, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[80552, 2505, 404, 10, 42, "Input"],
Cell[80959, 2517, 548, 13, 58, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[81522, 2533, 247, 6, 26, "Input"],
Cell[81772, 2541, 331, 8, 42, "Input"],
Cell[82106, 2551, 2160, 56, 138, "Input"],
Cell[84269, 2609, 106, 2, 26, "Input"]
}, Open  ]],
Cell[84390, 2614, 47, 0, 72, "Section"],
Cell[84440, 2616, 116, 2, 23, "Input"],
Cell[CellGroupData[{
Cell[84581, 2622, 128, 3, 95, "Section"],
Cell[84712, 2627, 83, 2, 25, "Input"],
Cell[84798, 2631, 108, 3, 95, "Section"],
Cell[CellGroupData[{
Cell[84931, 2638, 111, 1, 45, "Subsubsection",
 CellTags->"REFdata iterate restart"],
Cell[85045, 2641, 957, 29, 58, "Input"],
Cell[86005, 2672, 176, 5, 26, "Input"],
Cell[86184, 2679, 599, 15, 58, "Input"],
Cell[86786, 2696, 143, 3, 26, "Input"],
Cell[86932, 2701, 268, 8, 26, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[87237, 2714, 41, 0, 40, "Subsubsection"],
Cell[87281, 2716, 102, 3, 25, "Input"],
Cell[87386, 2721, 209, 6, 26, "Input"],
Cell[87598, 2729, 1232, 38, 138, "Input"],
Cell[88833, 2769, 1242, 31, 106, "Input"],
Cell[90078, 2802, 178, 5, 26, "Input"],
Cell[90259, 2809, 143, 3, 26, "Input"],
Cell[CellGroupData[{
Cell[90427, 2816, 57, 0, 42, "Text"],
Cell[90487, 2818, 404, 12, 42, "Input"],
Cell[90894, 2832, 237, 7, 26, "Input"],
Cell[91134, 2841, 52, 1, 26, "Input"],
Cell[91189, 2844, 601, 15, 58, "Input"],
Cell[91793, 2861, 971, 29, 90, "Input"],
Cell[92767, 2892, 135, 3, 26, "Input"],
Cell[92905, 2897, 534, 14, 58, "Input"],
Cell[93442, 2913, 342, 8, 42, "Input"],
Cell[93787, 2923, 320, 8, 42, "Input"],
Cell[94110, 2933, 216, 6, 26, "Input"],
Cell[94329, 2941, 70, 0, 42, "Text"],
Cell[94402, 2943, 1248, 39, 138, "Input"],
Cell[95653, 2984, 1422, 36, 122, "Input"],
Cell[97078, 3022, 181, 5, 26, "Input"],
Cell[97262, 3029, 346, 8, 42, "Input"],
Cell[97611, 3039, 432, 10, 58, "Input"],
Cell[98046, 3051, 1470, 38, 106, "Input"],
Cell[99519, 3091, 143, 3, 26, "Input"],
Cell[99665, 3096, 326, 7, 42, "Input"],
Cell[99994, 3105, 419, 10, 58, "Input"],
Cell[100416, 3117, 108, 3, 26, "Input"],
Cell[100527, 3122, 388, 10, 42, "Input"],
Cell[100918, 3134, 143, 3, 26, "Input"],
Cell[101064, 3139, 347, 8, 42, "Input"],
Cell[101414, 3149, 488, 11, 58, "Input"]
}, Open  ]],
Cell[101917, 3163, 50, 0, 40, "Subsubsection"],
Cell[101970, 3165, 52, 0, 39, "Text"],
Cell[CellGroupData[{
Cell[102047, 3169, 92, 1, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[102142, 3172, 116, 2, 26, "Input"],
Cell[102261, 3176, 84, 2, 26, "Input"],
Cell[102348, 3180, 248, 6, 26, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[102599, 3188, 107, 1, 42, "Text",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[102709, 3191, 1995, 56, 106, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[104707, 3249, 1276, 36, 74, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}],
Cell[105986, 3287, 639, 19, 42, "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.}]
}, Open  ]],
Cell[106640, 3309, 610, 17, 90, "Input"],
Cell[CellGroupData[{
Cell[107275, 3330, 152, 3, 95, "Section"],
Cell[107430, 3335, 35, 0, 26, "Input"],
Cell[107468, 3337, 170, 3, 26, "Input"],
Cell[107641, 3342, 1043, 30, 106, "Input"],
Cell[108687, 3374, 449, 11, 42, "Input"],
Cell[109139, 3387, 367, 10, 26, "Input"],
Cell[109509, 3399, 129, 4, 26, "Input"],
Cell[109641, 3405, 256, 6, 26, "Input"],
Cell[109900, 3413, 143, 3, 26, "Input"],
Cell[110046, 3418, 347, 8, 42, "Input"],
Cell[110396, 3428, 325, 8, 42, "Input"],
Cell[110724, 3438, 844, 24, 90, "Input"],
Cell[111571, 3464, 193, 6, 26, "Input"],
Cell[111767, 3472, 1209, 30, 90, "Input"],
Cell[112979, 3504, 350, 8, 42, "Input"],
Cell[113332, 3514, 555, 12, 58, "Input"],
Cell[113890, 3528, 274, 8, 26, "Input"],
Cell[114167, 3538, 193, 5, 26, "Input"],
Cell[CellGroupData[{
Cell[114385, 3547, 1550, 48, 154, "Input"],
Cell[115938, 3597, 68, 1, 26, "Input"]
}, Open  ]],
Cell[116021, 3601, 106, 2, 26, "Input"],
Cell[116130, 3605, 1845, 48, 138, "Input"],
Cell[117978, 3655, 391, 9, 42, "Input"],
Cell[118372, 3666, 529, 12, 58, "Input"],
Cell[118904, 3680, 93, 1, 26, "Input"],
Cell[119000, 3683, 2026, 52, 154, "Input"],
Cell[121029, 3737, 1164, 36, 90, "Input"],
Cell[122196, 3775, 345, 8, 42, "Input"],
Cell[122544, 3785, 494, 11, 58, "Input"],
Cell[123041, 3798, 106, 2, 26, "Input"],
Cell[123150, 3802, 2060, 55, 138, "Input"],
Cell[125213, 3859, 133, 3, 26, "Input"],
Cell[125349, 3864, 331, 8, 42, "Input"],
Cell[125683, 3874, 407, 9, 58, "Input"],
Cell[126093, 3885, 391, 10, 42, "Input"],
Cell[126487, 3897, 473, 12, 58, "Input"],
Cell[126963, 3911, 50, 0, 42, "Text"],
Cell[127016, 3913, 286, 6, 72, "Text"],
Cell[127305, 3921, 504, 15, 42, "Input"],
Cell[127812, 3938, 133, 3, 26, "Input"],
Cell[127948, 3943, 237, 6, 26, "Input"],
Cell[128188, 3951, 356, 10, 42, "Input"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[128583, 3966, 1031, 20, 186, "Input"],
Cell[129617, 3988, 242, 6, 26, "Input"],
Cell[129862, 3996, 321, 8, 42, "Input"]
}, Open  ]]
}, Open  ]],
Cell[130210, 4008, 48, 0, 72, "Section"],
Cell[130261, 4010, 21, 0, 51, "Title"],
Cell[CellGroupData[{
Cell[130307, 4014, 115, 3, 95, "Section"],
Cell[130425, 4019, 615, 19, 42, "Input"],
Cell[131043, 4040, 216, 7, 26, "Input"],
Cell[131262, 4049, 449, 12, 42, "Input"],
Cell[131714, 4063, 301, 7, 26, "Input"],
Cell[132018, 4072, 65, 1, 26, "Input"],
Cell[132086, 4075, 1035, 32, 90, "Input"],
Cell[133124, 4109, 63, 1, 26, "Input"],
Cell[133190, 4112, 275, 8, 26, "Input"],
Cell[133468, 4122, 441, 14, 42, "Input"],
Cell[133912, 4138, 67, 2, 25, "Input"],
Cell[133982, 4142, 599, 15, 58, "Input"]
}, Closed]]
}
]
*)

(* End of internal cache information *)
